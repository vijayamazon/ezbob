(function(){var n,t=function(n,t){return function(){return n.apply(t,arguments)}},i={}.hasOwnProperty,r=function(n,t){function u(){this.constructor=n}for(var r in t)i.call(t,r)&&(n[r]=t[r]);return u.prototype=t.prototype,n.prototype=new u,n.__super__=t.prototype,n};n=typeof exports!="undefined"&&exports!==null?exports:this,n.EzBob=n.EzBob||{},EzBob.Profile=EzBob.Profile||{},EzBob.Profile.ApplyForLoanView=function(n){function i(){return this.loanSelectionChanged=t(this.loanSelectionChanged,this),i.__super__.constructor.apply(this,arguments)}return r(i,n),i.prototype.template="#apply-forloan-template",i.prototype.initialize=function(n){if(this.customer=n.customer,this.customer.get("CreditSum")<EzBob.Config.XMinLoan){this.trigger("back"),document.location.href="#";return}if(this.fixed=this.customer.get("IsLoanDetailsFixed"),this.isLoanTypeSelectionAllowed=this.customer.get("IsLoanTypeSelectionAllowed"),this.currentLoanTypeID=1,this.currentRepaymentPeriod=this.customer.get("LastApprovedRepaymentPeriod"),this.recalculateThrottled=_.debounce(this.recalculateSchedule,250),this.timerId=setInterval(_.bind(this.refreshTimer,this),1e3),this.model.set({CreditSum:this.customer.get("CreditSum"),OfferValid:this.customer.offerValidFormatted()}),!this.fixed){this.model.on("change:neededCash",this.neededCashChanged,this);return this.isLoanSourceEU=n.model.get("isLoanSourceEU")}},i.prototype.events={"click .submit":"submit","change .preAgreementTermsRead":"showSubmit","change .agreementTermsRead":"showSubmit","change .euAgreementTermsRead":"showSubmit","click .download":"download","click .print":"print"},i.prototype.ui={submit:".submit",agreement:".agreement",form:"form"},i.prototype.loanSelectionChanged=function(){var n;return this.currentRepaymentPeriod=this.$("#loan-sliders .period-slider").slider("value"),n=this.$("#loan-sliders .amount-slider").slider("value"),this.model.set("neededCash",parseInt(n,10)),this.model.set("loanType",this.currentLoanTypeID),this.model.set("repaymentPeriod",this.currentRepaymentPeriod),this.neededCashChanged(!0)},i.prototype.showSubmit=function(){var n;return n=EzBob.Validation.checkForm(this.validator),this.model.set("agree",n),this.ui.submit.toggleClass("disabled",!n)},i.prototype.recalculateSchedule=function(n){var i,r,t=this;return r=n.value,BlockUi("on",this.$el.find("#block-loan-schedule")),BlockUi("on",this.$el.find("#block-agreement")),i="&loanType="+this.currentLoanTypeID+"&repaymentPeriod="+this.currentRepaymentPeriod,$.getJSON(""+window.gRootPath+"Customer/Schedule/Calculate?amount="+parseInt(r)+i).done(function(n){return t.renderSchedule(n),BlockUi("off",t.$el.find("#block-loan-schedule")),BlockUi("off",t.$el.find("#block-agreement"))})},i.prototype.renderSchedule=function(n){var t;return this.lastPaymentDate=moment(n.Schedule[n.Schedule.length-1].Date),t=new EzBob.LoanScheduleView({el:this.$el.find(".loan-schedule"),schedule:n,isShowGift:!1,isShowExportBlock:!1,isShowExceedMaxInterestForSource:!1}),t.render(),this.createAgreementView(n.Agreement)},i.prototype.neededCashChanged=function(n){var t;return this.$el.find(".preAgreementTermsRead, .agreementTermsRead, .euAgreementTermsRead").prop("checked",!1),t=this.model.get("neededCash"),this.ui.submit.attr("href",this.model.get("url")),this.recalculateThrottled({value:t,reloadSelectedOnly:n})},i.prototype.onRender=function(){var n,t,i=this;return this.fixed&&this.$(".cash-question").hide(),((n=this.isLoanTypeSelectionAllowed)===1||n==="1")&&!this.isLoanSourceEU||this.$(".duration-select-allowed").hide(),this.isLoanSourceEU||this.$(".eu-agreement-section").hide(),InitAmountPeriodSliders({container:this.$("#loan-sliders"),amount:{min:this.model.get("minCash"),max:this.model.get("maxCash"),start:this.model.get("maxCash"),step:100},period:{min:3,max:12,start:this.model.get("repaymentPeriod"),step:1,hide:!((t=this.isLoanTypeSelectionAllowed)===1||t==="1")||this.isLoanSourceEU},callback:function(n,t){if(t==="change")return i.loanSelectionChanged()}}),this.neededCashChanged(),this.$el.find("img[rel]").setPopover("right"),this.$el.find("li[rel]").setPopover("left"),this.validator=EzBob.validateLoanLegalForm(this.ui.form),this},i.prototype.refreshTimer=function(){return this.$el.find(".offerValidFor").text(this.customer.offerValidFormatted())},i.prototype.submit=function(n){var t,i,r,u;return(n.preventDefault(),t=this.model.get("neededCash"),r=this.model.get("maxCash"),u=this.model.get("minCash"),this.model.set("neededCash",t),this.model.set("loanType",this.currentLoanTypeID),this.model.set("repaymentPeriod",this.currentRepaymentPeriod),t>r||t<u)?!1:(i=EzBob.Validation.checkForm(this.validator),!i)?(this.showSubmit(),!1):(this.trigger("submit"),!1)},i.prototype.getCurrentViewId=function(){return this.$el.find("li.active a").attr("page-name")},i.prototype.print=function(){return printElement(this.getCurrentViewId()),!1},i.prototype.download=function(){var n,t,i,r;return n=parseInt(this.model.get("neededCash"),10),t=this.currentLoanTypeID,i=this.currentRepaymentPeriod,r=this.getCurrentViewId(),location.href=""+window.gRootPath+"Customer/Agreement/Download?amount="+n+"&viewName="+r+"&loanType="+t+"&repaymentPeriod="+i,!1},i.prototype.createAgreementView=function(n){var t,i,r;return t=this.customer.get("CustomerPersonalInfo").TypeOfBusiness,i=t===0||t===4||t===2,r=i?new EzBob.Profile.ConsumersAgreementView({el:this.ui.agreement}):new EzBob.Profile.CompaniesAgreementView({el:this.ui.agreement}),r.render(n),this.showSubmit()},i.prototype.close=function(){return clearInterval(this.timerId),this.model.off(),i.__super__.close.call(this)},i}(Backbone.Marionette.ItemView)}).call(this)