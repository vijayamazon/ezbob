(function(){var n,r={}.hasOwnProperty,t=function(n,t){function u(){this.constructor=n}for(var i in t)r.call(t,i)&&(n[i]=t[i]);return u.prototype=t.prototype,n.prototype=new u,n.__super__=t.prototype,n},i=function(n,t){return function(){return n.apply(t,arguments)}};n=typeof exports!="undefined"&&exports!==null?exports:this,n.EzBob=n.EzBob||{},EzBob.Profile=EzBob.Profile||{},EzBob.Profile.ApplyForLoanTopViewModel=function(n){function i(){return i.__super__.constructor.apply(this,arguments)}return t(i,n),i.prototype.defaults={state:"apply"},i}(Backbone.Model),EzBob.Profile.ApplyForLoanTopView=function(n){function r(){return this.createAddBankAccountView=i(this.createAddBankAccountView,this),this.createApplyForLoanView=i(this.createApplyForLoanView,this),r.__super__.constructor.apply(this,arguments)}return t(r,n),r.prototype.initialize=function(n){this.template=_.template($("#apply-forloan-top-template").html()),this.customer=n.customer,this.applyForLoanViewModel=new EzBob.Profile.ApplyForLoanModel({maxCash:this.customer.get("CreditSum"),OfferStart:this.customer.get("OfferStart"),loanType:this.customer.get("LastApprovedLoanTypeID"),repaymentPeriod:this.customer.get("LastApprovedRepaymentPeriod"),isLoanSourceEU:this.customer.get("IsLastApprovedLoanSourceEu")}),this.states={apply:this.createApplyForLoanView,bank:this.createAddBankAccountView};return this.model.on("change",this.render,this)},r.prototype.render=function(){var n,t;return this.$el.html(this.template()),t=this.states[this.model.get("state")](),$(".narrow-wizard-header").after($(".notifications")),n=new Backbone.Marionette.Region({el:this.$el.find(".apply-for-loan-div")}),n.show(t),!1},r.prototype.createApplyForLoanView=function(){var n=new EzBob.Profile.ApplyForLoanView({model:this.applyForLoanViewModel,customer:this.customer});n.on("submit",this.amountSelected,this);return n},r.prototype.createAddBankAccountView=function(){var n,t=this;n=new EzBob.BankAccountInfoView({model:this.customer});n.on("back",function(){return t.model.set("state","apply")});n.on("completed",function(){return t.submit()});return n},r.prototype.amountSelected=function(){var n;if(BlockUi("on"),n=$.post(""+window.gRootPath+"Customer/GetCash/LoanLegalSigned"),n.always(function(){return BlockUi("off")}),!this.customer.get("bankAccountAdded")){this.model.set("state","bank");return}return this.submit()},r.prototype.submit=function(){var n,t=this;if(n=new EzBob.Profile.PayPointCardSelectView({model:this.customer,date:this.lastPaymentDate}),n.cards.length>0){n.on("select",function(n){var i;return BlockUi("on"),i=$.post(""+window.gRootPath+"Customer/GetCash/Now",{cardId:n,amount:t.applyForLoanViewModel.get("neededCash")}),i.done(function(n){return n.error!==void 0?EzBob.ShowMessage(n.error,"Error occured"):document.location.href=n.url}),i.complete(function(){return BlockUi("off")})});n.on("existing",function(){return t._submit()});n.on("cancel",function(){return t.model.set("state","apply")});return EzBob.App.modal.show(n),!1}return this._submit(),!1},r.prototype._submit=function(){return BlockUi("on"),this.applyForLoanViewModel.buildUrl(),document.location.href=this.applyForLoanViewModel.get("url")},r}(Backbone.Marionette.ItemView)}).call(this)