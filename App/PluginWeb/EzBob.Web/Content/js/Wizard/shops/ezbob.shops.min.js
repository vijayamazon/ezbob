(function(){var n,t={}.hasOwnProperty,i=function(n,i){function u(){this.constructor=n}for(var r in i)t.call(i,r)&&(n[r]=i[r]);return u.prototype=i.prototype,n.prototype=new u,n.__super__=i.prototype,n};n=typeof exports!="undefined"&&exports!==null?exports:this;n.EzBob=n.EzBob||{};EzBob.StoreInfoView=function(n){function t(){return t.__super__.constructor.apply(this,arguments)}return i(t,n),t.prototype.attributes={"class":"stores-view"},t.prototype.isOffline=!1,t.prototype.initialize=function(){var h,i,u,e,b,n,f,y,c,r,t,k,o,s,p,w,l,a,v;this.ebayStores=new EzBob.EbayStoreModels;this.EbayStoreView=new EzBob.EbayStoreInfoView;this.ebayStores.on("reset         change",this.marketplacesChanged,this);this.amazonMarketplaces=new EzBob.AmazonStoreModels;this.AmazonStoreInfoView=new EzBob.AmazonStoreInfoView;this.amazonMarketplaces.on("reset change",this.marketplacesChanged,this);this.ekmAccounts=new EzBob.EKMAccounts;this.EKMAccountInfoView=new EzBob.EKMAccountInfoView({model:this.ekmAccounts});this.freeAgentAccounts=new EzBob.FreeAgentAccounts;this.FreeAgentAccountInfoView=new EzBob.FreeAgentAccountInfoView({model:this.freeAgentAccounts});this.sageAccounts=new EzBob.SageAccounts;this.sageAccountInfoView=new EzBob.SageAccountInfoView({model:this.sageAccounts});this.PayPointAccounts=new EzBob.PayPointAccounts;this.PayPointAccountInfoView=new EzBob.PayPointAccountInfoView({model:this.PayPointAccounts});this.YodleeAccounts=new EzBob.YodleeAccounts;this.YodleeAccountInfoView=new EzBob.YodleeAccountInfoView({model:this.YodleeAccounts});this.payPalAccounts=new EzBob.PayPalAccounts(this.model.get("paypalAccounts"));this.PayPalInfoView=new EzBob.PayPalInfoView({model:this.payPalAccounts});u=$.parseJSON($("div#cg-account-list").text());for(i in u)b=u[i],f=i.toLowerCase(),h=new EzBob.CGAccounts([],{accountType:i}),this[f+"Accounts"]=h,this[f+"AccountInfoView"]=new EzBob.CGAccountInfoView({model:h,accountType:i});this.stores={eBay:{view:this.EbayStoreView},Amazon:{view:this.AmazonStoreInfoView},paypal:{view:this.PayPalInfoView},EKM:{view:this.EKMAccountInfoView},PayPoint:{view:this.PayPointAccountInfoView},Yodlee:{view:this.YodleeAccountInfoView},FreeAgent:{view:this.FreeAgentAccountInfoView},Sage:{view:this.sageAccountInfoView}};for(i in u)k=u[i],f=i.toLowerCase(),this.stores[i]={view:this[f+"AccountInfoView"]};for(this.isOffline=this.model.get("isOffline"),this.isProfile=this.model.get("isProfile"),this.mpGroups={},l=EzBob.Config.MarketPlaceGroups,o=0,p=l.length;o<p;o++)e=l[o],this.mpGroups[e.Id]=e,e.ui=null;for(a=EzBob.Config.MarketPlaces,s=0,w=a.length;s<w;s++)n=a[s],t=n.Name==="Pay Pal"?"paypal":n.Name,this.stores[t]&&(this.stores[t].active=this.isProfile?this.isOffline?n.ActiveDashboardOffline:n.ActiveDashboardOnline:this.isOffline?n.ActiveWizardOffline:n.ActiveWizardOnline,this.stores[t].priority=this.isOffline?n.PriorityOffline:n.PriorityOnline,this.stores[t].ribbon=n.Ribbon?n.Ribbon:"",this.stores[t].button=new EzBob.StoreButtonView({name:t,mpAccounts:this.model}),this.stores[t].button.ribbon=n.Ribbon?n.Ribbon:"",this.stores[t].mandatory=this.isOffline?n.MandatoryOffline:n.MandatoryOnline,this.stores[t].groupid=n.Group!=null?n.Group.Id:0);this.isProfile||(this.allowFinishOnlineWizardWithoutMarketplaces=$("#allowFinishWizardWithoutMarketplaces").attr("online").toLowerCase()==="true",this.allowFinishOfflineWizardWithoutMarketplaces=$("#allowFinishWizardWithoutMarketplaces").attr("offline").toLowerCase()==="true");typeof c=="undefined"&&(c=Math.random()*10000000000000000);this.storeList=$(_.template($("#store-info").html(),{ordpi:c}));this.isReady=!1;v=this.stores;for(y in v){r=v[y];r.button.on("selected",this.connect,this);r.view.on("completed",_.bind(this.completed,this,r.button.name));r.view.on("back",this.back,this);r.button.on("ready",this.ready,this)}return EzBob.App.on("ct:storebase.shops.connect",this.connect,this)},t.prototype.events={"click a.connect-store":"close","click a.continue":"next","click .btn-showmore":"showMoreAccounts"},t.prototype.render=function(){var f,l,a,v,y,i,it,p,e,w,b,k,d,r,rt,ut,g,ft,n,t,u,o,et,s,h,c,ot,st,ht,nt,tt;for(t="",n="",et=_.sortBy(this.stores,function(n){return n.priority}),o=_.sortBy(et,function(n){return-n.button.shops.length}),w=o[0].button.shops.length>0,e=this.stores.eBay.button.shops.length>0,b=this.stores.paypal.button.shops.length>0,v=e&&!b,this.$el.find(".eBayPaypalRule").toggleClass("hide",!v),y=!0,nt=Object.keys(this.stores),s=0,ot=nt.length;s<ot;s++)k=nt[s],this.stores[k].button.shops.length===0&&this.stores[k].mandatory&&(y=!1);$(this.storeList).find(".back-store").remove();a=this.isProfile||w&&(!e||e&&b)&&y||this.isOffline&&this.allowFinishOfflineWizardWithoutMarketplaces||!this.isOffline&&this.allowFinishOnlineWizardWithoutMarketplaces;this.storeList.find(".continue").toggleClass("disabled",!a);this.handleMandatoryText(w,a,v);this.isOffline?(t=".offline_entry_message",n=".online_entry_message",this.storeList.find(".importantnumber").text("Â£150,000"),this.isProfile?this.storeList.find(".btn-showmore").remove():this.storeList.find(".btn-showmore").show()):(t=".online_entry_message",n=".offline_entry_message",this.storeList.find(".btn-showmore").remove());this.storeList.find(t).show();this.storeList.find(n).remove();this.isProfile?(t=".profile_message",n=".wizard_message"):(t=".wizard_message",n=".profile_message");this.storeList.find(t).show();this.storeList.find(n).remove();f=this.storeList.find(".accounts-list");f.empty();rt="Active"+(this.isProfile?"Dashboard":"Wizard")+(this.isOffline?"Offline":"Online");ft="Priority"+(this.isOffline?"Offline":"Online");r=[];tt=this.mpGroups;for(it in tt)i=tt[it],i[rt]&&r.push(i);for(r=_.sortBy(r,function(n){return n[ft]}),l=!0,h=0,st=r.length;h<st;h++)i=r[h],l?(l=!1,g="first"):g="following",p=this.storeList.find(".marketplace-group-template").clone().removeClass("marketplace-group-template hide").addClass(g).appendTo(f),$(".group-title",p).text(i.DisplayName),this.mpGroups[i.Id].ui=p;for(c=0,ht=o.length;c<ht;c++)(u=o[c],u.active)&&(d=this.mpGroups[u.groupid]&&this.mpGroups[u.groupid].ui?this.mpGroups[u.groupid].ui:f,ut=this.isProfile?"marketplace-button-profile":this.extractBtnClass(d),u.button.render().$el.addClass("marketplace-button "+ut).appendTo(d));return this.isOffline&&!this.isProfile&&this.storeList.find(".marketplace-button-more, .marketplace-group.following").hide(),this.storeList.appendTo(this.$el),EzBob.UiAction.registerView(this),this.amazonMarketplaces.trigger("reset"),this.ebayStores.trigger("reset"),this.$el.find("img[rel]").setPopover("left"),this.$el.find("li[rel]").setPopover("left"),this},t.prototype.showMoreAccounts=function(){return this.storeList.find(".btn-showmore").remove(),this.storeList.find(".marketplace-button-more, .marketplace-group.following").show()},t.prototype.extractBtnClass=function(n){var t;return t=n.attr("data-last-button-class")||"pull-right",t=t==="pull-right"?"pull-left":"pull-right",n.attr("data-last-button-class",t),t+(" marketplace-button-"+($(".marketplace-button-less",n).length<2?"less":"more"))},t.prototype.marketplacesChanged=function(){if(this.ebayStores.length>0||this.amazonMarketplaces.length>0)return this.$el.find(".wizard-top-notification h2").text("Add more shops to get more cash!")},t.prototype.connect=function(n){var i,t;return EzBob.CT.recordEvent("ct:storebase.shops.connect",n),this.$el.find(">div").hide(),t=this.stores[n].view,t.render().$el.appendTo(this.$el),i=t.$el.find("IMG.field_status"),i.filter(".required").field_status({required:!0}),i.not(".required").field_status({required:!1}),t.$el.show(),this.oldTitle=$(document).attr("title"),this.setDocumentTitle(t),this.setFocus(n),event.preventDefault(),!1},t.prototype.setFocus=function(n){var t;$.colorbox.close();switch(n){case"EKM":return this.$el.find("#ekm_login").focus();case"PayPoint":return this.$el.find("#payPoint_login").focus();default:if(t=$.parseJSON($("div#cg-account-list").text()),t[n])return $(".form_field","#"+n.toLowerCase()+"Account").first().focus()}},t.prototype.setDocumentTitle=function(n){var t;return t=n.getDocumentTitle(),t?$(document).attr("title","Step 2: "+t+" | EZBOB"):void 0},t.prototype.close=function(){return this},t.prototype.completed=function(n){return this.shopConnected(n),this.render(),this.trigger("completed")},t.prototype.back=function(){return this.$el.find(">div").hide(),this.storeList.show(),$(document).attr("title",this.oldTitle),this.updateEarnedPoints(),!1},t.prototype.next=function(){if(!this.$el.find(".continue").hasClass("disabled"))return $.post(window.gRootPath+"CustomerDetails/LinkAccountsComplete"),this.trigger("next"),EzBob.App.trigger("clear"),!1},t.prototype.ready=function(n){return this.trigger("ready",n),this.isReady?void 0:(this.isReady=!0,this.$el.find(".continue").show())},t.prototype.updateEarnedPoints=function(){return $.getJSON(""+window.gRootPath+"Customer/Wizard/EarnedPointsStr").done(function(n){if(n.EarnedPointsStr)return $("#EarnedPoints").text(n.EarnedPointsStr)})},t.prototype.shopConnected=function(n){var t=this;return this.model.safeFetch().done(function(){return t.stores[n].button.update(t.model.get("mpAccounts")),t.updateEarnedPoints(),t.render()})},t.prototype.handleMandatoryText=function(n,t,i){var e,c,r,o,u,f,h,s;if(o=!n||t||i,!o){for(e=!0,u="Please add the following accounts in order to continue: ",s=Object.keys(this.stores),f=0,h=s.length;f<h;f++)r=s[f],this.stores[r].button.shops.length===0&&this.stores[r].mandatory&&(c=!1,e||(u+=", "),e=!1,u+=r);this.storeList.find(".AddMoreRule").text(u)}return this.storeList.find(".AddMoreRule").toggleClass("hide",o)},t}(Backbone.View)}).call(this)