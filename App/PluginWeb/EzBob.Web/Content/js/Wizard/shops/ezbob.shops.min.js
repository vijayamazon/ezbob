(function(){var n,t={}.hasOwnProperty,i=function(n,i){function u(){this.constructor=n}for(var r in i)t.call(i,r)&&(n[r]=i[r]);return u.prototype=i.prototype,n.prototype=new u,n.__super__=i.prototype,n};n=typeof exports!="undefined"&&exports!==null?exports:this;n.EzBob=n.EzBob||{};EzBob.StoreInfoView=function(n){function t(){return t.__super__.constructor.apply(this,arguments)}return i(t,n),t.prototype.attributes={"class":"stores-view"},t.prototype.isOffline=function(){return this.fromCustomer("IsOffline")},t.prototype.isProfile=function(){return this.fromCustomer("IsProfile")},t.prototype.fromCustomer=function(n){var t;return(t=this.model.get("customer"),!t)?!1:n==="IsProfile"?t.createdInProfile:t.get(n)},t.prototype.initialize=function(){var i,n,e,t,r,o,u,f;this.renderExecuted=!1;this.ebayStores=new EzBob.EbayStoreModels;this.EbayStoreView=new EzBob.EbayStoreInfoView;this.ebayStores.on("reset change",this.marketplacesChanged,this);this.amazonMarketplaces=new EzBob.AmazonStoreModels;this.AmazonStoreInfoView=new EzBob.AmazonStoreInfoView;this.amazonMarketplaces.on("reset change",this.marketplacesChanged,this);this.ekmAccounts=new EzBob.EKMAccounts;this.EKMAccountInfoView=new EzBob.EKMAccountInfoView({model:this.ekmAccounts});this.freeAgentAccounts=new EzBob.FreeAgentAccounts;this.FreeAgentAccountInfoView=new EzBob.FreeAgentAccountInfoView({model:this.freeAgentAccounts});this.sageAccounts=new EzBob.SageAccounts;this.sageAccountInfoView=new EzBob.SageAccountInfoView({model:this.sageAccounts});this.PayPointAccounts=new EzBob.PayPointAccounts;this.PayPointAccountInfoView=new EzBob.PayPointAccountInfoView({model:this.PayPointAccounts});this.YodleeAccounts=new EzBob.YodleeAccounts;this.YodleeAccountInfoView=new EzBob.YodleeAccountInfoView({model:this.YodleeAccounts,isProfile:this.isProfile()});this.payPalAccounts=new EzBob.PayPalAccounts(this.model.get("paypalAccounts"));this.PayPalInfoView=new EzBob.PayPalInfoView({model:this.payPalAccounts});this.companyFilesAccounts=new EzBob.CompanyFilesAccounts(this.model.get("companyUploadAccounts"));this.companyFilesAccountInfoView=new EzBob.CompanyFilesAccountInfoView({model:this.companyFilesAccounts});u=EzBob.CgVendors.all();for(n in u)e=u[n],t=n.toLowerCase(),i=new EzBob.CgAccounts([],{accountType:n}),this[t+"Accounts"]=i,this[t+"AccountInfoView"]=t==="hmrc"?new EzBob.HmrcAccountInfoView({model:i,companyRefNum:(this.fromCustomer("CompanyInfo")||{}).ExperianRefNum}):new EzBob.CgAccountInfoView({model:i,accountType:n});this.stores={eBay:{view:this.EbayStoreView},Amazon:{view:this.AmazonStoreInfoView},paypal:{view:this.PayPalInfoView},EKM:{view:this.EKMAccountInfoView},PayPoint:{view:this.PayPointAccountInfoView},Yodlee:{view:this.YodleeAccountInfoView},FreeAgent:{view:this.FreeAgentAccountInfoView},Sage:{view:this.sageAccountInfoView},CompanyFiles:{view:this.companyFilesAccountInfoView}};f=EzBob.CgVendors.all();for(n in f)o=f[n],t=n.toLowerCase(),this.stores[n]={view:this[t+"AccountInfoView"]};typeof r=="undefined"&&(r=Math.random()*10000000000000000);this.storeList=$(_.template($("#store-info").html(),{ordpi:r}));EzBob.App.on("ct:storebase.shops.connect",this.connect,this);return this.isReady=!1},t.prototype.events={"click a.connect-store":"close","click a.continue":"next","click .btn-showmore":"toggleShowMoreAccounts","click .btn-go-to-link-accounts":"showLinkAccountsForm","click .btn-take-quick-offer":"takeQuickOffer","click .btn-back-to-quick-offer":"backToQuickOffer"},t.prototype.backToQuickOffer=function(){return this.shouldRemoveQuickOffer()?this.storeList.find(".quick-offer-form, .btn-back-to-quick-offer").remove():(this.storeList.find(".link-accounts-form").addClass("hide"),this.storeList.find(".quick-offer-form").removeClass("hide"))},t.prototype.takeQuickOffer=function(){var n;return n=$.post(window.gRootPath+"CustomerDetails/TakeQuickOffer"),n.done(function(){return EzBob.App.trigger("clear"),setTimeout(function(){return window.location=window.gRootPath+"Customer/Profile#GetCash"},500)}),!1},t.prototype.showLinkAccountsForm=function(){return this.storeList.find(".quick-offer-form").addClass("hide"),this.storeList.find(".link-accounts-form").removeClass("hide")},t.prototype.render=function(){var e,l,t,g,a,n,nt,v,r,tt,it,y,rt,u,ut,p,f,i,o,s,h,c,ft,et,ot,st,w,b,k,d;for(UnBlockUi(),this.mpGroups={},w=EzBob.Config.MarketPlaceGroups,o=0,ft=w.length;o<ft;o++)t=w[o],this.mpGroups[t.Id]=t,t.ui=null;for(b=EzBob.Config.MarketPlaces,s=0,et=b.length;s<et;s++)n=b[s],i=n.Name==="Pay Pal"?"paypal":n.Name,this.stores[i]&&(this.stores[i].active=this.isProfile()?this.isOffline()?n.ActiveDashboardOffline:n.ActiveDashboardOnline:this.isOffline()?n.ActiveWizardOffline:n.ActiveWizardOnline,this.stores[i].priority=this.isOffline()?n.PriorityOffline:n.PriorityOnline,this.stores[i].ribbon=n.Ribbon?n.Ribbon:"",this.stores[i].button=new EzBob.StoreButtonView({name:i,mpAccounts:this.model,description:n.Description}),this.stores[i].button.ribbon=n.Ribbon?n.Ribbon:"",this.stores[i].mandatory=this.isOffline()?n.MandatoryOffline:n.MandatoryOnline,this.stores[i].groupid=n.Group!=null?n.Group.Id:0);k=this.stores;for(nt in k){f=k[nt];f.button.on("selected",this.connect,this);f.view.on("completed",_.bind(this.completed,this,f.button.name));f.view.on("back",this.back,this);f.button.on("ready",this.ready,this)}this.canContinue();this.renderExecuted?this.shouldRemoveQuickOffer()&&(this.storeList.find(".quick-offer-form, .btn-back-to-quick-offer").remove(),this.storeList.find(".link-accounts-form").removeClass("hide")):(this.storeList.find(".quick-offer-form, .link-accounts-form").addClass("hide"),this.shouldShowQuickOffer()?(this.storeList.find(".quick-offer-form").removeClass("hide"),this.renderQuickOfferForm()):(this.storeList.find(".link-accounts-form").removeClass("hide"),this.shouldRemoveQuickOffer()&&this.storeList.find(".quick-offer-form, .btn-back-to-quick-offer").remove()));this.renderExecuted=!0;this.showOrRemove();e=this.storeList.find(".accounts-list");e.empty();tt="Active"+(this.isProfile()?"Dashboard":"Wizard")+(this.isOffline()?"Offline":"Online");rt="Priority"+(this.isOffline()?"Offline":"Online");r=[];d=this.mpGroups;for(g in d)t=d[g],t[tt]&&r.push(t);for(r=_.sortBy(r,function(n){return n[rt]}),l=!0,h=0,ot=r.length;h<ot;h++)t=r[h],l?(l=!1,y="first"):y="following",a=this.storeList.find(".marketplace-group-template").clone().removeClass("marketplace-group-template hide").addClass(y).appendTo(e),$(".group-title",a).text(t.DisplayName),this.mpGroups[t.Id].ui=a;for(p=_.sortBy(this.stores,function(n){return n.priority}),c=0,st=p.length;c<st;c++)(u=p[c],u.active)&&(v=this.mpGroups[u.groupid]&&this.mpGroups[u.groupid].ui?this.mpGroups[u.groupid].ui:e,it=this.isProfile()?"marketplace-button-profile":this.extractBtnClass(v),u.button.render().$el.addClass("marketplace-button "+it).appendTo(v));return this.isOffline()&&!this.isProfile()&&this.storeList.find(".marketplace-button-more, .marketplace-group.following").hide(),this.storeList.find(".marketplace-group.following .marketplace-button-full, .marketplace-button-full.marketplace-button-more").length&&this.showMoreAccounts(),this.storeList.appendTo(this.$el),EzBob.UiAction.registerView(this),this.amazonMarketplaces.trigger("reset"),this.ebayStores.trigger("reset"),this.$el.find("img[rel]").setPopover("left"),this.$el.find("li[rel]").setPopover("left"),ut=this.$el.find(".btn-showmore"),ut.hover(function(){return $(".onhover",this).animate({top:0,opacity:1})},function(){return $(".onhover",this).animate({top:"60px",opacity:0})}),this},t.prototype.renderQuickOfferForm=function(){return this.storeList.find(".immediate-offer .amount, .quick-offer-amount").text(EzBob.formatPoundsNoDecimals(this.quickOffer.Amount)),this.storeList.find(".immediate-offer .term").text(this.quickOffer.ImmediateTerm+" months"),this.storeList.find(".immediate-offer .interest-rate .value").text(EzBob.formatPercentsWithDecimals(this.quickOffer.ImmediateInterestRate)),this.setQuickOfferFormOnHover(this.storeList.find(".immediate-offer .btn-take-quick-offer")),this.storeList.find(".potential-offer .amount").text(EzBob.formatPoundsNoDecimals(this.quickOffer.PotentialAmount)),this.storeList.find(".potential-offer .term").text("up to "+this.quickOffer.PotentialTerm+" months"),this.storeList.find(".potential-offer .interest-rate .value").text(EzBob.formatPercentsWithDecimals(this.quickOffer.PotentialInterestRate)),this.setQuickOfferFormOnHover(this.storeList.find(".potential-offer .btn-go-to-link-accounts"))},t.prototype.setQuickOfferFormOnHover=function(n){return n.hover(function(){var t,i;return n=$(this),t=n.outerHeight(),t=n.outerWidth(),i=n.parent().find(".onhover"),i.css({position:"absolute",top:t,height:t,left:0,width:t,display:"block"}),i.animate({top:0,opacity:1})},function(){var t,i;return n=$(this),i=n.parent().find(".onhover"),t=n.outerHeight(),i.animate({top:t,opacity:0})})},t.prototype.shouldRemoveQuickOffer=function(){return this.quickOffer?moment.utc().diff(moment.utc(this.quickOffer.ExpirationDate))>0:!0},t.prototype.shouldShowQuickOffer=function(){return this.isProfile()?!1:(this.quickOffer=this.fromCustomer("QuickOffer"),!this.quickOffer)?!1:(this.requestedAmount=this.fromCustomer("RequestedAmount"),!this.requestedAmount)?!1:moment.utc().diff(moment.utc(this.quickOffer.ExpirationDate))<0},t.prototype.showOrRemove=function(){var r,i,n,t;return r=this.isOffline(),i=this.isProfile(),$(this.storeList).find(".back-store").remove(),t="",n="",this.storeList.find(".marketplace-button.show-more").show(),r?(t=".offline_entry_message",n=".online_entry_message",this.storeList.find(".importantnumber").text("Â£150,000"),i?(this.storeList.find(".marketplace-button.show-more").hide(),this.storeList.find(".AddMoreRuleBottom").removeClass("hide")):this.storeList.find(".btn-showmore").show()):(t=".online_entry_message",n=".offline_entry_message",this.storeList.find(".marketplace-button.show-more").hide(),this.storeList.find(".AddMoreRuleBottom").removeClass("hide")),this.storeList.find(t).show(),this.storeList.find(n).remove(),i?(t=".profile_message",n=".wizard_message"):(t=".wizard_message",n=".profile_message"),this.storeList.find(t).show(),this.storeList.find(n).remove()},t.prototype.toggleShowMoreAccounts=function(){var n;return n=this.storeList.find(".btn-showmore"),n.attr("data-current")==="more"?this.showMoreAccounts():this.showLessAccounts()},t.prototype.showLessAccounts=function(){var n;return n=this.storeList.find(".btn-showmore"),n.attr("data-current","more"),n.find(".caption").text("Show more account types"),n.find(".rotate90").html("&laquo;"),n.find(".onhover-cell").text("Show more data source connectors"),this.storeList.find(".AddMoreRuleBottom").addClass("hide"),this.storeList.find(".marketplace-button-more, .marketplace-group.following").hide(),this.storeList.find(".marketplace-button").not(".show-more, .marketplace-button-less").css("display","none")},t.prototype.showMoreAccounts=function(){var n;return n=this.storeList.find(".btn-showmore"),n.attr("data-current","less"),n.find(".caption").text("Show less account types"),n.find(".rotate90").html("&raquo;"),n.find(".onhover-cell").text("Show less data source connectors"),this.storeList.find(".AddMoreRuleBottom").removeClass("hide"),this.storeList.find(".marketplace-button-more, .marketplace-group.following").show(),this.storeList.find(".marketplace-button").not(".show-more").css("display","table")},t.prototype.canContinue=function(){var n,t,i,r,f,e,o,u;i=!1;u=this.stores;for(f in u)if(e=u[f],e.button.shops.length){i=!0;break}return t=this.stores.eBay.button.shops.length>0,r=this.stores.paypal.button.shops.length>0,this.$el.find(".eBayPaypalRule").toggleClass("hide",!(t&&!r)),n=!1,this.isProfile()?n=!0:i&&(!t||t&&r)?n=!0:(o=this.isOffline()?"offline":"online",n=$("#allowFinishWizardWithoutMarketplaces").data(o).toLowerCase()==="true"),this.storeList.find(".continue").toggleClass("disabled",!n),this.storeList.find(".AddMoreRule").toggleClass("hide",n),i},t.prototype.extractBtnClass=function(n){var t;return t="pull-left",$(".marketplace-button-less",n).length<3?t+=" marketplace-button-less":(t+=" marketplace-button-more",this.isOffline()&&!this.isProfile()&&$(".marketplace-button-more",n).length===0&&(t+=" marketplace-button-more-first")),t},t.prototype.marketplacesChanged=function(){if(this.ebayStores.length>0||this.amazonMarketplaces.length>0)return this.$el.find(".wizard-top-notification h2").text("Add more shops to get more cash!")},t.prototype.connect=function(n){var i,t;return EzBob.CT.recordEvent("ct:storebase.shops.connect",n),this.$el.find(">div").hide(),t=this.stores[n].view,t.render().$el.appendTo(this.$el),i=t.$el.find("IMG.field_status"),i.filter(".required").field_status({required:!0}),i.not(".required").field_status({required:!1}),t.$el.show(),this.oldTitle=$(document).attr("title"),this.setDocumentTitle(t),this.setFocus(n),!1},t.prototype.setFocus=function(n){$.colorbox.close();switch(n){case"EKM":return this.$el.find("#ekm_login").focus();case"PayPoint":return this.$el.find("#payPoint_login").focus();default:if(EzBob.CgVendors.pure()[n])return $(".form_field","#"+n.toLowerCase()+"Account").first().focus()}},t.prototype.setDocumentTitle=function(n){var t;return t=n.getDocumentTitle(),t?$(document).attr("title","Step 4: "+t+" | EZBOB"):void 0},t.prototype.close=function(){return this},t.prototype.completed=function(n){return this.shopConnected(n),this.trigger("completed")},t.prototype.back=function(){return this.$el.find(">div").hide(),this.storeList.show(),$(document).attr("title",this.oldTitle),!1},t.prototype.next=function(){var n,t;if(n=this.$el.find(".continue"),!n.hasClass("disabled"))return BlockUi("on"),n.addClass("disabled"),t=$.post(window.gRootPath+"CustomerDetails/LinkAccountsComplete"),t.done(function(){return EzBob.App.trigger("clear"),window.location=window.gRootPath+"CustomerDetails/Dashboard"}),t.error(function(){return UnBlockUi()}),!1},t.prototype.ready=function(n){return this.trigger("ready",n),this.isReady?void 0:(this.isReady=!0,this.$el.find(".continue").show())},t.prototype.shopConnected=function(n){var t=this;return this.model.get("customer").safeFetch().done(function(){return t.stores[n].button.update(t.fromCustomer("mpAccounts")),t.render()})},t}(Backbone.View)}).call(this)