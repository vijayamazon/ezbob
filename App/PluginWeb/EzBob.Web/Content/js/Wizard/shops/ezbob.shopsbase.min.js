(function(){var n,t={}.hasOwnProperty,i=function(n,i){function u(){this.constructor=n}for(var r in i)t.call(i,r)&&(n[r]=i[r]);return u.prototype=i.prototype,n.prototype=new u,n.__super__=i.prototype,n};n=typeof exports!="undefined"&&exports!==null?exports:this;n.EzBob=n.EzBob||{};EzBob.StoreInfoBaseView=function(n){function t(){return t.__super__.constructor.apply(this,arguments)}return i(t,n),t.prototype.isOffline=!1,t.prototype.initialize=function(){var r,t,n,i;this.allowFinishOnlineWizardWithoutMarketplaces=$("#allowFinishWizardWithoutMarketplaces").attr("online").toLowerCase()==="true";this.allowFinishOfflineWizardWithoutMarketplaces=$("#allowFinishWizardWithoutMarketplaces").attr("offline").toLowerCase()==="true";typeof t=="undefined"&&(t=Math.random()*10000000000000000);this.storeList=$(_.template($("#store-info").html(),{ordpi:t}));this.isReady=!1;i=this.stores;for(r in i){n=i[r];n.button.on("selected",this.connect,this);n.view.on("completed",_.bind(this.completed,this,n.button.name));n.view.on("back",this.back,this);n.button.on("ready",this.ready,this)}return EzBob.App.on("ct:storebase."+this.name+".connect",this.connect,this)},t.prototype.completed=function(n){return this.shopConnected(n),this.render(),this.trigger("completed")},t.prototype.back=function(){return this.$el.find(">div").hide(),this.storeList.show(),$(document).attr("title",this.oldTitle),this.updateEarnedPoints(),!1},t.prototype.next=function(){if(!this.$el.find(".continue").hasClass("disabled"))return $.post(window.gRootPath+"CustomerDetails/LinkAccountsComplete"),this.trigger("next"),EzBob.App.trigger("clear"),!1},t.prototype.ready=function(n){return this.trigger("ready",n),this.isReady?void 0:(this.isReady=!0,this.$el.find(".continue").show())},t.prototype.updateEarnedPoints=function(){return $.getJSON(""+window.gRootPath+"Customer/Wizard/EarnedPointsStr").done(function(n){if(n.EarnedPointsStr)return $("#EarnedPoints").text(n.EarnedPointsStr)})},t.prototype.shopConnected=function(n){var t;return t=this,this.model.safeFetch().done(function(){return t.stores[n].button.update(t.model.get("mpAccounts")),t.updateEarnedPoints(),t.render()})},t.prototype.render=function(){var p,o,s,h,i,c,w,l,r,a,n,t,v,u,b,g,f,e,k,d,y;for(w=this.stores.HMRC.button.shops.length>0,t="",n="",g=this,p=this.storeList.find(".accounts-list"),b=_.sortBy(this.stores,function(n){return n.priority}),u=_.sortBy(b,function(n){return-n.button.shops.length}),c=u[0].button.shops.length>0,i=this.stores.eBay.button.shops.length>0,l=this.stores.paypal.button.shops.length>0,s=i&&!l,this.$el.find(".eBayPaypalRule").toggleClass("hide",!s),h=!0,y=Object.keys(this.stores),f=0,k=y.length;f<k;f++)a=y[f],this.stores[a].button.shops.length===0&&this.stores[a].mandatory&&(h=!1);for(r=this.model.get("isProfile"),r||$(this.storeList).find(".back-store").hide(),o=r||c&&(!i||i&&l)&&h||this.isOffline&&this.allowFinishOfflineWizardWithoutMarketplaces||!this.isOffline&&this.allowFinishOnlineWizardWithoutMarketplaces,this.storeList.find(".continue").toggleClass("disabled",!o),this.handleMandatoryText(c,o,s),this.isOffline?(t=".offline_entry_message",n=".online_entry_message",w||this.storeList.find(".btn-continue").text("Skip, I'll do it later").removeClass("disabled"),this.storeList.find(".importantnumber").text("Â£150,000")):(t=".online_entry_message",n=".offline_entry_message"),this.storeList.find(t).show(),this.storeList.find(n).remove(),r?(t=".profile_message",n=".wizard_message"):(t=".wizard_message",n=".profile_message"),this.storeList.find(t).show(),this.storeList.find(n).remove(),e=0,d=u.length;e<d;e++)v=u[e],v.active&&v.button.render().$el.appendTo(p);return this.storeList.appendTo(this.$el),EzBob.UiAction.registerView(this),this},t.prototype.events={"click a.connect-store":"close","click a.continue":"next"},t.prototype.handleMandatoryText=function(n,t,i){var e,c,r,o,u,f,h,s;if(o=!n||t||i,!o){for(e=!0,u="Please add the following accounts in order to continue: ",s=Object.keys(this.stores),f=0,h=s.length;f<h;f++)r=s[f],this.stores[r].button.shops.length===0&&this.stores[r].mandatory&&(c=!1,e||(u+=", "),e=!1,u+=r);this.storeList.find(".AddMoreRule").text(u)}return this.storeList.find(".AddMoreRule").toggleClass("hide",o)},t.prototype.connect=function(n){var i,t;return EzBob.CT.recordEvent("ct:storebase."+this.name+".connect",n),this.$el.find(">div").hide(),t=this.stores[n].view,t.render().$el.appendTo(this.$el),i=t.$el.find("IMG.field_status"),i.filter(".required").field_status({required:!0}),i.not(".required").field_status({required:!1}),t.$el.show(),this.oldTitle=$(document).attr("title"),this.setDocumentTitle(t),this.setFocus(n),!1},t.prototype.setFocus=function(n){var t;$.colorbox.close();switch(n){case"EKM":return this.$el.find("#ekm_login").focus();case"PayPoint":return this.$el.find("#payPoint_login").focus();default:if(t=$.parseJSON($("div#cg-account-list").text()),t[n])return $(".form_field","#"+n.toLowerCase()+"Account").first().focus()}},t.prototype.setDocumentTitle=function(n){var t;return t=n.getDocumentTitle(),t?$(document).attr("title","Step 2: "+t+" | EZBOB"):void 0},t.prototype.close=function(){return this},t}(Backbone.View)}).call(this)