(function(){var n,t={}.hasOwnProperty,i=function(n,i){function u(){this.constructor=n}for(var r in i)t.call(i,r)&&(n[r]=i[r]);return u.prototype=i.prototype,n.prototype=new u,n.__super__=i.prototype,n};n=typeof exports!="undefined"&&exports!==null?exports:this;n.EzBob=n.EzBob||{};EzBob.HMRCAccountInfoView=function(n){function t(){return t.__super__.constructor.apply(this,arguments)}return i(t,n),t.prototype.events={"change input":"inputChanged","keyup input":"inputChanged","click a.hmrcBack":"back","click div.hmrcUploadButton":"uploadFiles","click a.linkAccountBack":"linkAccountBack","click a.uploadFilesBack":"uploadFilesBack","click a.connect-account":"connect","click a.connect-account-help":"connect","click a.select-vat":"selectVatFiles","click #linkHelpButton":"getLinkHelp","click #uploadHelpButton":"getUploadHelp","click div.hmrcLinkButton":"linkAccount","click a.newVatFilesUploadButton":"doUploadFiles","click #uploadAndLinkHelpButton":"getUploadAndLinkHelp"},t.prototype.initialize=function(){return this.uploadFilesDlg=null,this.accountType="HMRC",this.template="#"+this.accountType+"AccountInfoTemplate",this.activeForm=void 0,this.isOldInternetExplorer="Microsoft Internet Explorer"===navigator.appName&&navigator.appVersion.indexOf("MSIE 1")===-1},t.prototype.render=function(){var n;return t.__super__.render.call(this),n=this,Dropzone.options.hmrcAccountUpload={init:function(){return this.on("complete",function(){var t;if(this.getUploadingFiles().length===0&&this.getQueuedFiles().length===0)return t=this.getAcceptedFiles()!==0,n.$el.find("a.newVatFilesUploadButton").toggleClass("disabled",!t)})}},this.$el.find("#hmrcAccountUpload").dropzone(),this},t.prototype.inputChanged=function(){var n;return this.activeForm===void 0&&(this.activeForm=this.$el.find("#hmrcLinkAccountForm"),this.validator=EzBob.validateHmrcLinkForm(this.activeForm)),n=EzBob.Validation.checkForm(this.validator),this.$el.find("a.connect-account").toggleClass("disabled",!n),this.$el.find("a.connect-account-help").toggleClass("disabled",!n)},t.prototype.linkAccount=function(){return this.activeForm=this.$el.find("#hmrcLinkAccountForm"),this.validator=EzBob.validateHmrcLinkForm(this.activeForm),this.$el.find("#linkAccountDiv").show(),this.$el.find("#initialDiv").hide()},t.prototype.uploadFiles=function(){return this.$el.find("#uploadFilesDiv").show(),this.$el.find("#initialDiv").hide(),this.isOldInternetExplorer?this.$el.find(".newVatFilesUpload").hide():this.$el.find(".oldVatFilesUpload").hide()},t.prototype.doUploadFiles=function(){var n,t;return this.$el.find(".newVatFilesUpload").hasClass("disabled")?!1:(n=this,BlockUi("on"),t=$.post(window.gRootPath+"Hmrc/UploadFiles"),t.done(function(t){return t.error!==void 0?EzBob.App.trigger("error","Failed to Save HMRC Account"):(EzBob.App.trigger("info","HMRC Account Added Successfully"),n.trigger("completed"),n.trigger("back"),n.$el.find("#uploadFilesDiv").hide(),n.$el.find("#initialDiv").show())}),t.always(function(){return BlockUi("off")}))},t.prototype.back=function(){return this.trigger("back"),!1},t.prototype.linkAccountBack=function(){return this.$el.find("#linkAccountDiv").hide(),this.$el.find("#initialDiv").show(),!1},t.prototype.uploadFilesBack=function(){return this.$el.find("#uploadFilesDiv").hide(),this.$el.find("#initialDiv").show(),!1},t.prototype.getDocumentTitle=function(){return EzBob.App.trigger("clear"),"Link HMRC Account"},t.prototype.connect=function(){var i,r,t,n=this;return(this.activeForm===void 0&&(this.activeForm=this.$el.find("#hmrcLinkAccountForm"),this.validator=EzBob.validateHmrcLinkForm(this.activeForm)),!EzBob.Validation.checkForm(this.validator))?(this.validator.form(),!1):this.$el.find("a.connect-account").hasClass("disabled")?!1:(r=this.buildModel(),!r)?(EzBob.App.trigger("error","HMRC Account Data Validation Error"),!1):(i=new EzBob.CGAccountModel(r),t=i.save(),!t)?(EzBob.App.trigger("error","HMRC Account Saving Error"),!1):(BlockUi("on"),t.always(function(){return BlockUi("off")}),t.fail(function(){return EzBob.App.trigger("error","Failed to Save HMRC Account")}),t.done(function(t){if(t.error)return EzBob.App.trigger("error",t.error),!1;try{n.model.add(i)}catch(r){}return EzBob.App.trigger("info","HMRC Account Added Successfully"),n.$el.find("#hmrc_user_id").val(""),n.$el.find("#hmrc_password").val(""),n.$el.find("#linkAccountDiv").hide(),n.$el.find("#initialDiv").show(),n.activeForm=n.$el.find("#hmrcLinkAccountForm"),n.validator=EzBob.validateHmrcLinkForm(n.activeForm),n.inputChanged(),n.trigger("completed"),n.trigger("back")}),!1)},t.prototype.buildModel=function(){var n;return n=$.parseJSON($("div#cg-account-model-template").text()),n.accountTypeName="HMRC",n.login=this.$el.find("#hmrc_user_id").val(),n.name=this.$el.find("#hmrc_user_id").val(),n.password=this.$el.find("#hmrc_password").val(),delete n.id,n},t.prototype.selectVatFiles=function(n){var t,i,r=this;for(n.preventDefault(),t="f"+(new Date).getTime()+"x"+Math.floor(Math.random()*1e9),i="model"+(new Date).getTime()+"x"+Math.floor(Math.random()*1e9);window[t];)t+=Math.floor(Math.random()*1e3);while(window[i])i+=Math.floor(Math.random()*1e3);return window[i]=function(){return r.buildModel()},window[t]=function(n){var u;return delete window[t],delete window[i],r.uploadFileDlg.dialog("close"),r.uploadFileDlg=null,u=JSON.parse(n),u.error?EzBob.App.trigger("error","Problem Linking HMRC Account: "+u.error.Data.error):u.submitted&&EzBob.App.trigger("info","HMRC Account Added Successfully"),r.trigger("completed"),r.trigger("back")},$("iframe",this.$el.find("div#upload-files-form")).each(function(n,r){return r.setAttribute("width",570),r.setAttribute("height",515),r.setAttribute("src",""+window.gRootPath+"Customer/CGMarketPlaces/UploadFilesDialog?key="+t+"&handler=HandleUploadedHmrcVatReturn&modelkey="+i)}),this.uploadFileDlg=this.$el.find("div#upload-files-form").dialog({height:600,width:600,modal:!0,title:"Please upload the VAT returns",resizable:!1,dialogClass:"upload-files-dialog",closeOnEscape:!1}),!1},t.prototype.getLinkHelp=function(){var n;return n=$("#hmrcLinkHelpPopup"),n.length>0?$.colorbox({inline:!0,open:!0,href:n,width:"35%"}):void 0},t.prototype.getUploadHelp=function(){var n;return n=$("#hmrcUploadHelpPopup"),n.length>0?$.colorbox({inline:!0,open:!0,href:n,width:"35%"}):void 0},t.prototype.getUploadAndLinkHelp=function(){var n;return n=$("#hmrcUploadAndLinkHelpPopup"),n.length>0?$.colorbox({inline:!0,open:!0,href:n,width:"35%"}):void 0},t}(Backbone.Marionette.ItemView)}).call(this)