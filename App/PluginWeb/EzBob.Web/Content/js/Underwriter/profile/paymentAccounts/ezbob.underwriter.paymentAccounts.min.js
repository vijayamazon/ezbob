(function(){var n,i={}.hasOwnProperty,t=function(n,t){function u(){this.constructor=n}for(var r in t)i.call(t,r)&&(n[r]=t[r]);return u.prototype=t.prototype,n.prototype=new u,n.__super__=t.prototype,n};n=typeof exports!="undefined"&&exports!==null?exports:this;n.EzBob=n.EzBob||{};EzBob.Underwriter=EzBob.Underwriter||{};EzBob.Underwriter.PaymentAccountsModel=function(n){function i(){return i.__super__.constructor.apply(this,arguments)}return t(i,n),i.prototype.urlRoot=function(){return""+window.gRootPath+"Underwriter/PaymentAccounts/Index/"+this.customerId},i.prototype.getCardById=function(n){var i,r,t,f,u;if(r=this.get("CurrentBankAccount"),parseInt(r.Id)===parseInt(n))return r;for(u=this.get("BankAccounts"),t=0,f=u.length;t<f;t++)if(i=u[t],parseInt(i.Id)===parseInt(n))return i},i}(Backbone.Model);EzBob.Underwriter.PaymentAccountView=function(n){function i(){return i.__super__.constructor.apply(this,arguments)}return t(i,n),i.prototype.template="#payment-accounts-template",i.prototype.initialize=function(){var n=this;return this.bindTo(this.model,"change reset sync",this.render,this),window.paypointAdded=function(t){return t==null&&(t=5),EzBob.ShowMessage("Please deduct the "+t+" pounds from this card using manual payment","Reminder"),n.model.fetch()}},i.prototype.serializeData=function(){var n,t;return n=this.model.get("BankAccounts")||[],t=this.model.get("CurrentBankAccount"),t&&(t.isDefault=!0,n.push(t)),n=_.sortBy(n,"BankAccount"),{bankAccounts:n,paymentAccounts:this.model.toJSON(),customerId:this.model.customerId}},i.prototype.events={"click .bankAccounts tbody tr":"showBankAccount","click .checkeBankAccount":"checkBanckAccount","click .add-existing":"addExistingCard","click .setDefault":"setDefault","click .addNewDebitCard":"addNewDebitCard","click .set-paypoint-default":"setPaypointDefault"},i.prototype.onRender=function(){return this.$el.find(".bankAccounts i[data-title]").tooltip({placement:"right"})},i.prototype.setPaypointDefault=function(n){var r,u,t,i,f=this;return r=$(n.currentTarget),t=r.data("transactionid"),u=_.find(this.model.get("PayPointCards"),function(n){return n.TransactionId===t}),BlockUi("on"),i=$.post(""+window.gRootPath+"Underwriter/PaymentAccounts/SetPaypointDefaultCard",{customerId:this.model.customerId,transactionId:t,cardNo:u.CardNo}),i.complete(function(){return BlockUi("off")}),i.done(function(){return f.model.fetch()})},i.prototype.showBankAccount=function(n){var t;return n.target.tagName==="BUTTON"?!1:(t=$(n.currentTarget).data("card-id"),this._showBankAccount(t))},i.prototype._showBankAccount=function(n){var t,i,r;return(t=this.model.getCardById(n),!((t!=null?t.Bank:void 0)!=null))?(i=(t!=null?t.StatusInformation:void 0)||"Validation was not performed",EzBob.ShowMessage(i,"Bank account check"),!1):(r=new EzBob.Underwriter.BankAccountDetailsView({model:new Backbone.Model(t)}),EzBob.App.jqmodal.show(r),!1)},i.prototype.addNewDebitCard=function(){var n,t=this;n=new EzBob.Underwriter.AddBankAccount({customerId:this.model.customerId});n.on("saved",function(){return t.model.fetch()});return EzBob.App.jqmodal.show(n),!1},i.prototype.setDefault=function(n){var t,i,r=this;t=$(n.currentTarget).parents("tr").data("card-id");i=$.post(""+window.gRootPath+"Underwriter/PaymentAccounts/SetDefaultCard",{customerId:this.model.customerId,cardId:t});i.done(function(){return r.model.fetch()})},i.prototype.checkBanckAccount=function(n){var t,r,i=this;return t=$(n.currentTarget).parents("tr").data("card-id"),BlockUi("On"),r=$.ajax({url:""+window.gRootPath+"Underwriter/PaymentAccounts/PerformCheckBankAccount",data:{id:this.model.customerId,cardid:t},global:!1,type:"POST"}),r.done(function(n){var r;if(n.error){i.model.fetch();BlockUi("Off");EzBob.ShowMessage(n.error,"Error");return}return r=i.model.fetch(),r.done(function(){return i._showBankAccount(t),BlockUi("Off")})})},i.prototype.addExistingCard=function(){var n,t,i=this;n=new EzBob.Underwriter.PayPointCardModel;t=new EzBob.Underwriter.AddPayPointCardView({model:n});t.on("save",function(){var t,r;return BlockUi("on"),t=n.toJSON(),t.customerId=i.model.customerId,r=$.post(""+window.gRootPath+"Underwriter/PaymentAccounts/AddPayPointCard",t),r.done(function(){return BlockUi("off"),i.model.fetch()})});return EzBob.App.jqmodal.show(t),!1},i}(Backbone.Marionette.ItemView)}).call(this)