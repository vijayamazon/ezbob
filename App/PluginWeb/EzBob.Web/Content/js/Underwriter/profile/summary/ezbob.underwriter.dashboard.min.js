(function(){var n,t={}.hasOwnProperty,i=function(n,i){function u(){this.constructor=n}for(var r in i)t.call(i,r)&&(n[r]=i[r]);return u.prototype=i.prototype,n.prototype=new u,n.__super__=i.prototype,n};n=typeof exports!="undefined"&&exports!==null?exports:this;n.EzBob=n.EzBob||{};EzBob.Underwriter=EzBob.Underwriter||{};EzBob.Underwriter.DashboardView=function(n){function t(){return t.__super__.constructor.apply(this,arguments)}return i(t,n),t.prototype.template="#dashboard-template",t.prototype.initialize=function(n){return this.crmModel=n.crmModel,this.personalModel=n.personalModel,this.experianModel=n.experianModel,this.propertiesModel=n.propertiesModel,this.mpsModel=n.mpsModel,this.loanModel=n.loanModel,this.companyModel=n.companyModel,this.bindTo(this.model,"change sync",this.render,this),this.bindTo(this.crmModel,"change sync",this.render,this),this.bindTo(this.personalModel,"change sync",this.personalModelChanged,this),this.bindTo(this.experianModel,"change sync",this.render,this),this.bindTo(this.companyModel,"change sync",this.render,this),this.bindTo(this.propertiesModel,"change sync",this.render,this),this.bindTo(this.mpsModel,"change sync",this.render,this),this.bindTo(this.loanModel,"change sync",this.render,this),this.expCompany=[]},t.prototype.serializeData=function(){var n=this;return this.expCompany=[],this.companyModel.get("DashboardModel")&&this.expCompany.push(this.companyModel.get("DashboardModel")),this.companyModel.get("Owners")&&_.each(this.companyModel.get("Owners"),function(t){return n.expCompany.push(t.DashboardModel)}),{m:this.model.toJSON(),crm:_.first(_.filter(this.crmModel.get("CustomerRelations"),function(n){return n.User!=="System"}),5),experian:this.experianModel.toJSON(),company:this.expCompany,properties:this.propertiesModel.toJSON(),mps:this.mpsModel.toJSON(),loan:this.loanModel.toJSON(),affordability:_.first(_.filter(this.mpsModel.toJSON(),function(n){return n.Name==="HMRC"}),1)}},t.prototype.events={'click a[data-action="collapse"]':"boxToolClick",'click a[data-action="close"]':"boxToolClick",'click a[href^="#companyExperian"]':"companyChanged"},t.prototype.companyChanged=function(n){var t;return t=n.currentTarget,this.$el.find(".company-name").text($(t).data("companyname")+" "+$(t).data("companyref"))},t.prototype.boxToolClick=function(n){var r,i,t;t=n.currentTarget;$(t).data("action")===undefined&&!1;r=$(t).data("action");i=$(t);switch(r){case"collapse":$(i).children("i").addClass("anim-turn180");$(t).parents(".box").children(".box-content").slideToggle(500,function(){return $(this).is(":hidden")?$(i).children("i").attr("class","fa fa-chevron-down"):$(i).children("i").attr("class","fa fa-chevron-up"),!1});break;case"close":$(t).parents(".box").fadeOut(500,function(){return $(this).parent().remove(),!1});break;case"config":$("#"+$(t).data("modal")).modal("show")}return!1},t.prototype.personalModelChanged=function(n,t){if(n&&t&&this.model)return this.model.fetch()},t.prototype.onRender=function(){var n,t,o,s,h,c,r,u,i,e,f=this;if(this.$el.find("a[data-bug-type]").tooltip({title:"Report bug"}),this.model.get("Alerts")!==void 0&&(this.model.get("Alerts").length===0?$("#customer-label-span").removeClass("label-warning").removeClass("label-important").addClass("label-success"):_.some(this.model.get("Alerts"),function(n){return n.AlertType==="danger"})?$("#customer-label-span").removeClass("label-success").removeClass("label-warning").addClass("label-important"):$("#customer-label-span").removeClass("label-success").removeClass("label-important").addClass("label-warning")),this.experianModel&&this.experianModel.get("ConsumerHistory")&&(r=_.sortBy(this.experianModel.get("ConsumerHistory"),function(n){return n.Date}),h=_.pluck(r,"Score").join(","),this.$el.find(".consumerScoreGraph").attr("values",h),s=_.pluck(r,"CII").join(","),this.$el.find(".consumerCIIGraph").attr("values",s)),this.experianModel&&this.experianModel.get("CompanyHistory")&&(r=_.sortBy(this.experianModel.get("CompanyHistory"),function(n){return n.Date}),o=_.pluck(r,"Score").join(","),this.$el.find(".companyScoreGraph0").attr("values",o)),this.$el.find(".inline-sparkline").sparkline("html",{width:"100%",height:"100%",lineWidth:2,spotRadius:3.5,lineColor:"#cfcfcf",fillColor:"transparent",spotColor:"#cfcfcf",maxSpotColor:"#cfcfcf",minSpotColor:"#cfcfcf",valueSpots:{":":"#cfcfcf"}}),i=this.propertiesModel.toJSON(),i&&i.NetWorth&&this.drawDonut(this.$el.find("#assets-donut"),"#00ab5d",i.NetWorth/(i.NetWorth+i.SumOfMortgages)),this.$el.find('[data-toggle="tooltip"]').tooltip({placement:"bottom"}),n=this.$el.find("#consumerScoreCanvas"),this.halfDonut(n,n.data("color"),n.data("percent")),t=this.$el.find("#consumerCIICanvas"),this.halfDonut(t,t.data("color"),t.data("percent")),this.expCompany&&this.expCompany.length>0&&_.each(this.expCompany,function(n,t){var i,r,u;return i=f.$el.find("#companyScoreCanvas"+t),f.halfDonut(i,i.data("color"),i.data("percent")),u=_.pluck(n.FinDataHistories,"AdjustedProfit").reverse().join(","),f.$el.find("#companyProfit"+t).attr("values",u),r=_.pluck(n.FinDataHistories,"TangibleEquity").reverse().join(","),f.$el.find("#companyEquity"+t).attr("values",r)}),this.$el.find(".bar-sparkline").sparkline("html",{type:"bar",barColor:"#cfcfcf",height:"50px"}),this.experianModel&&this.experianModel.get("directorsModels")){for(c=this.experianModel.get("directorsModels").length,u=0,e=[];u<c;)n=this.$el.find("#directorScoreCanvas"+u),this.halfDonut(n,n.data("color"),n.data("percent")),t=this.$el.find("#directorCIICanvas"+u),this.halfDonut(t,t.data("color"),t.data("percent")),e.push(u++);return e}},t.prototype.halfDonut=function(n,t,i){var u,r,f,c,l,e,o,s,h;return u=n[0],r=u.getContext("2d"),s=u.width/2,h=u.height/2,e=40,o=1*Math.PI,c=2*Math.PI,f=!1,l=15,r.beginPath(),r.arc(s,h,e,o,c,f),r.lineWidth=l,r.strokeStyle="#ebebeb",r.stroke(),r.beginPath(),r.arc(s,h,e,o,Math.PI*(1+i),f),r.strokeStyle=t,r.stroke()},t.prototype.drawDonut=function(n,t,i){var u,r,h,c,f,e,o,s;u=n[0];r=u.getContext("2d");o=u.width/2;s=u.height/2;f=70;e=1*Math.PI;h=4*Math.PI;c=25;r.beginPath();r.arc(o,s,f,e,h,!1);r.lineWidth=c;r.strokeStyle="#ebebeb";r.stroke();r.beginPath();r.arc(o,s,f,e,Math.PI*(1+i*2),!1);r.strokeStyle=t;r.stroke()},t}(Backbone.Marionette.ItemView)}).call(this)