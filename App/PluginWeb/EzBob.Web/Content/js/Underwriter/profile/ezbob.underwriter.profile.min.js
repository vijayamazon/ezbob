(function(){var n,t={}.hasOwnProperty,i=function(n,i){function u(){this.constructor=n}for(var r in i)t.call(i,r)&&(n[r]=i[r]);return u.prototype=i.prototype,n.prototype=new u,n.__super__=i.prototype,n};n=typeof exports!="undefined"&&exports!==null?exports:this;n.EzBob=n.EzBob||{};EzBob.Underwriter.ProfileView=function(n){function t(){return t.__super__.constructor.apply(this,arguments)}return i(t,n),t.prototype.initialize=function(){var n;return this.template=_.template($("#profile-template-main").html()),(EzBob.CrmActions!=null||EzBob.CrmActions.length===0)&&(n=$.get(window.gRootPath+"Underwriter/CustomerRelations/CrmStatic",function(n){return EzBob.CrmActions=n.CrmActions,EzBob.CrmStatuses=n.CrmStatuses,EzBob.CrmRanks=n.CrmRanks})),EzBob.RejectReasons!=null||EzBob.RejectReasons.length===0?$.get(window.gRootPath+"Underwriter/Customers/RejectReasons",function(n){return EzBob.RejectReasons=n.reasons}):void 0},t.prototype.render=function(){var w,i,r,u,f,e,o,s,h,c,l,a,v,y,p,n,t=this;this.$el.html(this.template());y=this.$el.find(".profile-person-info");o=this.$el.find(".profile-loan-info");p=this.$el.find("#profile-summary");u=this.$el.find("#dashboard");h=this.$el.find("#marketplaces");f=this.$el.find("#credit-bureau");a=this.$el.find("#payment-accounts");s=this.$el.find("#loanhistorys");c=this.$el.find("#medal-calc");l=this.$el.find("#messages");i=this.$el.find("#apiChecks");r=this.$el.find("#customerRelations");w=this.$el.find("#alerts-passed");v=this.$el.find("#profileHead");e=this.$el.find("#fraudDetection");this.personalInfoModel=new EzBob.Underwriter.PersonalInfoModel;this.profileInfoView=new EzBob.Underwriter.PersonInfoView({el:y,model:this.personalInfoModel});this.marketPlaces=new EzBob.Underwriter.MarketPlaces;this.marketPlaceView=new EzBob.Underwriter.MarketPlacesView({el:h,model:this.marketPlaces,personalInfoModel:this.personalInfoModel});n=this;this.marketPlaceView.on("rechecked",this.mpRechecked,this.marketPlaces);EzBob.App.vent.on("ct:marketplaces.history",function(t){return n.show(n.marketPlaces.customerId,!0,t)});this.loanHistory=new EzBob.Underwriter.LoanHistoryModel;this.loanHistoryView=new EzBob.Underwriter.LoanHistoryView({el:s,model:this.loanHistory});this.experianInfoModel=new EzBob.Underwriter.ExperianInfoModel;this.experianInfoView=new EzBob.Underwriter.ExperianInfoView({el:f,model:this.experianInfoModel});this.loanInfoModel=new EzBob.Underwriter.LoanInfoModel;this.loanInfoView=new EzBob.Underwriter.LoanInfoView({el:o,model:this.loanInfoModel,personalInfo:this.personalInfoModel,parentView:this});this.summaryInfoModel=new EzBob.Underwriter.SummaryInfoModel;this.summaryInfoView=new EzBob.Underwriter.SummaryInfoView({el:p,model:this.summaryInfoModel});EzBob.App.vent.on("newCreditLine:done",function(){return t.summaryInfoModel.fetch()});EzBob.App.vent.on("newCreditLine:pass",function(){return t.summaryInfoModel.fetch()});this.paymentAccountsModel=new EzBob.Underwriter.PaymentAccountsModel;this.paymentAccountsView=new EzBob.Underwriter.PaymentAccountView({el:a,model:this.paymentAccountsModel});this.paymentAccountsView.on("rechecked",this.mpRechecked,this.paymentAccountsModel);this.medalCalculationModel=new EzBob.Underwriter.MedalCalculationModel;this.medalCalculationView=new EzBob.Underwriter.MedalCalculationView({el:c,model:this.medalCalculationModel});this.pricingModelScenarios=new EzBob.Underwriter.PricingModelScenarios;this.pricingModelCalculationsModel=new EzBob.Underwriter.PricingModelCalculationsModel;this.pricingModelScenarios.fetch();this.pricingModelCalculationsView=new EzBob.Underwriter.PricingModelCalculationsView({el:this.$el.find("#pricing-calc"),model:this.pricingModelCalculationsModel,scenarios:this.pricingModelScenarios});this.companyScoreModel=new EzBob.Underwriter.CompanyScoreModel;this.companyScoreView=new EzBob.Underwriter.CompanyScoreView({el:n.$el.find("#company-score-list"),model:this.companyScoreModel});n.$el.find("a.company-score-tab").on("shown.bs.tab",function(){return n.companyScoreView.redisplayAccordion()});this.crossCheckView=new EzBob.Underwriter.CrossCheckView({el:this.$el.find("#customer-info")});this.messagesModel=new EzBob.Underwriter.MessageModel;this.Message=new EzBob.Underwriter.Message({el:l,model:this.messagesModel});this.Message.on("creditResultChanged",this.changedSystemDecision,this);this.alertDocs=new EzBob.Underwriter.Docs;this.alertDocsView=new EzBob.Underwriter.AlertDocsView({el:this.$el.find("#alert-docs"),model:this.alertDocs});this.ApicCheckLogs=new EzBob.Underwriter.ApiChecksLogs;this.ApiChecksLogView=new EzBob.Underwriter.ApiChecksLogView({el:i,model:this.ApicCheckLogs});this.crmModel=new EzBob.Underwriter.CustomerRelationsModel;this.CustomerRelationsView=new EzBob.Underwriter.CustomerRelationsView({el:r,model:this.crmModel});this.FraudDetectionLogs=new EzBob.Underwriter.fraudDetectionLogModel;this.FraudDetectionLogView=new EzBob.Underwriter.FraudDetectionLogView({el:e,model:this.FraudDetectionLogs});this.PropertiesModel=new EzBob.Underwriter.Properties;this.dashboardInfoView=new EzBob.Underwriter.DashboardView({el:u,model:this.summaryInfoModel,crmModel:this.crmModel,personalModel:this.personalInfoModel,experianModel:this.experianInfoModel,propertiesModel:this.PropertiesModel,mpsModel:this.marketPlaces,loanModel:this.loanInfoModel});this.profileHeadView=new EzBob.Underwriter.ProfileHeadView({el:v,model:this.summaryInfoModel,personalModel:this.personalInfoModel,loanModel:this.loanInfoModel,medalModel:this.medalCalculationModel});this.showed=!0;EzBob.handleUserLayoutSetting();this.$el.find('.profile-tabs a[data-toggle="tab"]').on("shown.bs.tab",function(n){return t.setLastShownProfileSection($(n.target).attr("href").substr(1)),$(n.currentTarget).attr("href")==="#dashboard"?$(".inline-sparkline").sparkline("html",{width:"100%",height:"100%",lineWidth:2,spotRadius:3,lineColor:"#88bbc8",fillColor:"#f2f7f9",spotColor:"green",maxSpotColor:"#00AEEF",minSpotColor:"red",chartRangeMin:-1,valueSpots:{":":"green"}}):void 0});return this},t.prototype.setState=function(n,t){return this.lastShownCustomerID=n,t?void 0:this.getLastShownProfileSection(this.$el.find("a.customer-tab:first").attr("href").substr(1))},t.prototype.restoreState=function(){return this.$el.find("a.customer-tab").filter('[href="#'+this.getLastShownProfileSection(this.$el.find("a.customer-tab:first").attr("href").substr(1))+'"]').tab("show")},t.prototype.setLastShownProfileSection=function(n){return localStorage["underwriter.profile.lastShownProfileSection"]=n},t.prototype.getLastShownProfileSection=function(n){var t;return t=localStorage["underwriter.profile.lastShownProfileSection"],t||(t=n,this.setLastShownProfileSection(t)),t},t.prototype.events={"click #RejectBtn":"RejectBtnClick","click #ApproveBtn":"ApproveBtnClick","click #EscalateBtn":"EscalateBtnClick","click #SuspendBtn":"SuspendBtnClick","click #ReturnBtn":"ReturnBtnClick","click .add-director":"addDirectorClicked"},t.prototype.addDirectorClicked=function(n){var t,u,f,i,r=this;return n.stopPropagation(),n.preventDefault(),this.$el.find(".add-director").hide(),f=new EzBob.DirectorModel,i=this.$el.find(".add-director-container"),u={FirstName:this.personalInfoModel.get("FirstName"),Surname:this.personalInfoModel.get("Surname"),DateOfBirth:this.personalInfoModel.get("DateOfBirth"),Gender:this.personalInfoModel.get("Gender"),PostCode:this.personalInfoModel.get("PostCode"),Directors:this.personalInfoModel.get("Directors")},t=new EzBob.AddDirectorInfoView({model:f,el:i,backButtonCaption:"Cancel",failOnDuplicate:!1,customerInfo:u}),t.setBackHandler(function(){return r.onDirectorAddCanceled()}),t.setSuccessHandler(function(){return r.onDirectorAdded()}),t.setDupCheckCompleteHandler(function(n){return r.onDuplicateCheckComplete(n)}),t.render(),t.setCustomerID(this.customerId),i.show(),!1},t.prototype.onDuplicateCheckComplete=function(n){return n?this.$el.find(".duplicate-director-detected").show():this.$el.find(".duplicate-director-detected").hide()},t.prototype.onDirectorAddCanceled=function(){return this.$el.find(".add-director-container").hide().empty(),this.$el.find(".add-director").show()},t.prototype.onDirectorAdded=function(){return this.onDirectorAddCanceled(),this.show(this.customerId)},t.prototype.recordRecentCustomers=function(n){var t;return t=$.post(""+gRootPath+"Underwriter/Customers/SetRecentCustomer",{id:n}),t.done(function(n){return localStorage.setItem("RecentCustomers",JSON.stringify(n.RecentCustomers))})},t.prototype.checkCustomerAvailability=function(n){var t;return t=n.toJSON(),t.success===!1?(EzBob.ShowMessage(t.error,"Error",function(){return Redirect("#")},"OK"),!1):(this.showed&&this.$el.show(),this.restoreState())},t.prototype.mpRechecked=function(n){var t,i;return t=this,i=n.umi,t.fetch().done(function(){var r,u;return r=$("#"+n.el.attr("id")),r.addClass("disabled"),u=setInterval(function(){var n;return n=$.get(window.gRootPath+"Underwriter/MarketPlaces/CheckForUpdatedStatus",{mpId:i}),n.done(function(n){if(n.status!=="In progress")return clearInterval(u),t.fetch().done(function(){return r.removeClass("disabled")})})},1e3)})},t.prototype.disableChange=function(n){return this.show(n,!1)},t.prototype.RejectBtnClick=function(n){var t;if($(n.currentTarget).hasClass("disabled"))return!1;t=new EzBob.Underwriter.RejectedDialog({model:this.loanInfoModel});t.render();t.on("changedSystemDecision",this.changedSystemDecision,this);return!1},t.prototype.ApproveBtnClick=function(n){var t;return $(n.currentTarget).hasClass("disabled")?!1:this.loanInfoModel.get("InterestRate")<=0?(EzBob.ShowMessage("Wrong Interest Rate value ("+this.loanInfoModel.get("InterestRate")+"), please enter the valid value (above zero)","Error"),!1):this.loanInfoModel.get("OfferedCreditLine")<=0?(EzBob.ShowMessage("Wrong Offered credit line value ("+this.loanInfoModel.get("OfferedCreditLine")+"), please enter the valid value (above zero)","Error"),!1):this.loanInfoModel.get("OfferExpired")?(EzBob.ShowMessage("Loan offer has expired. Set new validity date.","Error"),!1):(this.skipPopupForApprovalWithoutAML=this.loanInfoModel.get("SkipPopupForApprovalWithoutAML"),this.loanInfoModel.get("AMLResult")!=="Passed"&&!this.skipPopupForApprovalWithoutAML)?(t=new EzBob.Underwriter.ApproveLoanWithoutAML({model:this.loanInfoModel,parent:this,skipPopupForApprovalWithoutAML:this.skipPopupForApprovalWithoutAML}),EzBob.App.jqmodal.show(t),!1):this.CheckCustomerStatusAndCreateApproveDialog()},t.prototype.CheckCustomerStatusAndCreateApproveDialog=function(){var n;return this.personalInfoModel.get("IsWarning")?(n=new EzBob.Underwriter.ApproveLoanForWarningStatusCustomer({model:this.personalInfoModel,parent:this}),EzBob.App.jqmodal.show(n),!1):this.CreateApproveDialog()},t.prototype.CreateApproveDialog=function(){var n=new EzBob.Underwriter.ApproveDialog({model:this.loanInfoModel});n.on("changedSystemDecision",this.changedSystemDecision,this);return n.render(),!1},t.prototype.EscalateBtnClick=function(n){var t;if($(n.currentTarget).hasClass("disabled"))return!1;t=new EzBob.Underwriter.Escalated({model:this.loanInfoModel});t.render();t.on("changedSystemDecision",this.changedSystemDecision,this);return!1},t.prototype.SuspendBtnClick=function(n){var t;if($(n.currentTarget).hasClass("disabled"))return!1;t=new EzBob.Underwriter.Suspended({model:this.loanInfoModel});t.render();t.on("changedSystemDecision",this.changedSystemDecision,this);return!1},t.prototype.ReturnBtnClick=function(n){var t;if($(n.currentTarget).hasClass("disabled"))return!1;t=new EzBob.Underwriter.Returned({model:this.loanInfoModel});t.render();t.on("changedSystemDecision",this.changedSystemDecision,this);return!1},t.prototype.changedSystemDecision=function(){return this.summaryInfoModel.fetch(),this.personalInfoModel.fetch(),this.loanInfoModel.fetch(),this.loanHistory.fetch()},t.prototype.show=function(n,t,i){var u,e,f,r=this;return this.hide(),BlockUi("on"),scrollTop(),e=this,this.customerId=n,u=new EzBob.Underwriter.CustomerFullModel({customerId:n,history:(f=EzBob.parseDate(i))!=null?f:{history:null}}),u.fetch().done(function(){switch(u.get("State")){case"NotFound":EzBob.ShowMessage(res.error,"Customer id. #"+n+" was not found");r.router.navigate("",{trigger:!0,replace:!0});return}return r.personalInfoModel.set({Id:n},{silent:!0}),r.personalInfoModel.set(u.get("PersonalInfoModel"),{silent:!0}),r.personalInfoModel.trigger("sync"),r.loanInfoModel.set({Id:n},{silent:!0}),r.loanInfoModel.set(u.get("ApplicationInfoModel"),{silent:!0}),r.loanInfoModel.trigger("sync"),r.marketPlaces.customerId=n,r.marketPlaces.history=i,r.marketPlaces.reset(u.get("Marketplaces"),{silent:!0}),r.marketPlaces.trigger("sync"),r.loanHistory.customerId=n,r.loanHistoryView.idCustomer=n,r.loanHistory.set(u.get("LoansAndOffers"),{silent:!0}),r.loanHistory.trigger("sync"),r.summaryInfoModel.set({Id:n,success:!0},{silent:!0}),r.summaryInfoModel.set(u.get("SummaryModel"),{silent:!0}),r.summaryInfoModel.trigger("sync"),r.checkCustomerAvailability(r.summaryInfoModel),r.recordRecentCustomers(n),EzBob.UpdateBugsIcons(u.get("Bugs")),r.experianInfoModel.set({Id:n},{silent:!0}),r.experianInfoModel.set(u.get("CreditBureauModel"),{silent:!0}),r.experianInfoModel.trigger("sync"),r.paymentAccountsModel.customerId=n,r.paymentAccountsModel.set(u.get("PaymentAccountModel"),{silent:!0}),r.paymentAccountsModel.trigger("sync"),r.medalCalculationModel.set({Id:n},{silent:!0}),r.medalCalculationModel.set(u.get("MedalCalculations"),{silent:!0}),r.medalCalculationModel.trigger("sync"),r.pricingModelCalculationsModel.set({Id:n},{silent:!0}),r.pricingModelCalculationsModel.set(u.get("PricingModelCalculations"),{silent:!0}),r.pricingModelCalculationsModel.trigger("sync"),r.PropertiesModel.set({Id:n},{silent:!0}),r.PropertiesModel.set(u.get("Properties"),{silent:!0}),r.PropertiesModel.trigger("sync"),r.FraudDetectionLogs.customerId=n,r.FraudDetectionLogView.customerId=n,r.FraudDetectionLogs.set(u.get("FraudDetectionLog"),{silent:!0}),r.FraudDetectionLogs.trigger("sync"),r.ApicCheckLogs.customerId=n,r.ApiChecksLogView.idCustomer=n,r.ApicCheckLogs.reset(u.get("ApiCheckLogs"),{silent:!0}),r.ApicCheckLogs.trigger("sync"),r.messagesModel.set({Id:n},{silent:!0}),r.messagesModel.set({attaches:u.get("Messages"),silent:!0}),r.messagesModel.trigger("sync"),r.crmModel.customerId=n,r.crmModel.set(u.get("CustomerRelations"),{silent:!0}),r.crmModel.trigger("sync"),r.alertDocs.reset(u.get("AlertDocs"),{silent:!0}),r.alertDocsView.create(n),r.alertDocs.trigger("sync"),r.companyScoreModel.customerId=n,r.companyScoreModel.set(u.get("CompanyScore"),{silent:!0}),r.companyScoreModel.trigger("sync"),r.crossCheckView.marketPlaces=r.marketPlaces,r.crossCheckView.companyScore=r.companyScoreModel,r.crossCheckView.experianDirectors=u.get("ExperianDirectors"),r.crossCheckView.fullModel=u,r.crossCheckView.render({customerId:n}),t&&$("a[href=#marketplaces]").click(),BlockUi("Off")}),EzBob.handleUserLayoutSetting()},t.prototype.hide=function(){return this.$el.hide()},t.prototype.updateAlerts=function(){return this.alertsModel.fetch()},t}(EzBob.View)}).call(this)