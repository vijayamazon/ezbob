(function(){var n,i={}.hasOwnProperty,t=function(n,t){function u(){this.constructor=n}for(var r in t)i.call(t,r)&&(n[r]=t[r]);return u.prototype=t.prototype,n.prototype=new u,n.__super__=t.prototype,n};n=typeof exports!="undefined"&&exports!==null?exports:this;n.EzBob=n.EzBob||{};EzBob.Underwriter=EzBob.Underwriter||{};EzBob.Underwriter.MarketPlaceModel=function(n){function i(){return i.__super__.constructor.apply(this,arguments)}return t(i,n),i.prototype.idAttribute="Id",i.prototype.initialize=function(){this.on("change reset",this.recalculate,this);return this.recalculate()},i.prototype.recalculate=function(){var i,e,n,r,o,u,f,t;return n=this.get("AnalysisDataInfo"),i=this.get("AccountAge"),f=n?(n.TotalSumofOrders1M||0)*1:0,u=n?(n.TotalSumofOrdersAnnualized1M||0)*1:0,r=n?(n.TotalSumofOrders12M||n.TotalSumofOrders6M||n.TotalSumofOrders3M||n.TotalSumofOrders1M||0)*1:0,o=n&&!isNaN(n.TotalValueofInventoryLifetime*1)?n.TotalValueofInventoryLifetime*1:"-",t=this.get("PayPal"),t&&(f=t.GeneralInfo.MonthInPayments,u=t.GeneralInfo.MonthInPaymentsAnnualized,r=t.GeneralInfo.TotalNetInPayments),e=i!=="-"&&i!=="undefined"?EzBob.SeniorityFormat(i,0):"-",this.set({age:e,monthSales:f,monthAnnualizedSales:u,anualSales:r,inventory:o},{silent:!0})},i}(Backbone.Model);EzBob.Underwriter.MarketPlaces=function(n){function i(){return i.__super__.constructor.apply(this,arguments)}return t(i,n),i.prototype.model=EzBob.Underwriter.MarketPlaceModel,i.prototype.url=function(){return""+window.gRootPath+"Underwriter/MarketPlaces/Index/?id="+this.customerId+"&history="+this.history},i}(Backbone.Collection);EzBob.Underwriter.MarketPlacesView=function(n){function i(){return i.__super__.constructor.apply(this,arguments)}return t(i,n),i.prototype.template="#marketplace-template",i.prototype.initialize=function(){this.model.on("reset change sync",this.render,this);return this.rendered=!1,window.YodleeTryRecheck=function(n){return n.error?EzBob.ShowMessage(n.error,"Yodlee Recheck Error","OK"):EzBob.ShowMessage("Yodlee recheked successfully, refresh the page",null,"OK")},this},i.prototype.onRender=function(){var t,n,i=this;this.$el.find(".mp-error-description").tooltip({placement:"bottom"});this.$el.find("a[data-bug-type]").tooltip({title:"Report bug"});_.each(this.$el.find("[data-original-title]"),function(n){return $(n).tooltip({title:n.getAttribute("data-original-title")})});this.detailView!==void 0&&this.detailView.render();t=this.$el.find("#marketplaces-history");this.marketPlacesHistory=new EzBob.Underwriter.MarketPlacesHistory;this.marketPlacesHistory.customerId=this.model.customerId;this.marketPlacesHistory.silent=!0;this.marketPlaceHistoryView=new EzBob.Underwriter.MarketPlacesHistoryView({model:this.marketPlacesHistory,el:t,customerId:this.model.customerId});n=this;EzBob.App.vent.on("ct:marketplaces.history",function(){if(n.uploadHmrcView)return n.uploadHmrcView.close(),n.uploadHmrcView=null});EzBob.App.vent.on("ct:marketplaces.uploadHmrc",function(){return n.uploadHmrcView?(n.uploadHmrcView.render(),n.uploadHmrcView.$el.show()):(n.uploadHmrcView=new EzBob.Underwriter.UploadHmrcView({el:n.$el.find("#hmrc-upload"),customerId:i.model.customerId}),n.uploadHmrcView.render()),$(".mps-tables").hide()});EzBob.App.vent.on("ct:marketplaces.uploadHmrcBack",function(){return $(".mps-tables").show(),n.uploadHmrcView.close(),n.uploadHmrcView=null});return this},i.prototype.events={"click .tryRecheckYodlee":"tryRecheckYodlee","click .reCheckMP":"reCheckmarketplaces","click tbody tr":"rowClick","click .mp-error-description":"showMPError","click .renew-token":"renewTokenClicked","click .disable-shop":"disableShop","click .enable-shop":"enableShop"},i.prototype.rowClick=function(n){var t,i;if(!n.target.getAttribute("href")&&n.target.tagName!=="I"&&(t=n.currentTarget.getAttribute("data-id"),t)){i=this.model.get(t);this.detailView=new EzBob.Underwriter.MarketPlaceDetailsView({model:this.model,currentId:t,customerId:this.model.customerId,personalInfoModel:this.options.personalInfoModel});EzBob.App.jqmodal.show(this.detailView);this.detailView.on("reCheck",this.reCheckmarketplaces,this);this.detailView.on("disable-shop",this.disableShop,this);this.detailView.on("enable-shop",this.enableShop,this);this.detailView.on("recheck-token",this.renewToken);return this.detailView.customerId=this.model.customerId,this.detailView.render()}},i.prototype.showMPError=function(){return!1},i.prototype.serializeData=function(){var r,n,u,t,f,i,o,e;for(r=$.parseJSON($("div#cg-account-list").text()),u=function(n){var t;return r[n.get("Name")]?(t=r[n.get("Name")],t.Behaviour===0&&!t.HasExpenses):!n.get("IsPaymentAccount")},n={customerId:this.model.customerId,marketplaces:_.sortBy(_.pluck(_.filter(this.model.models,function(n){return n&&u(n)}),"attributes"),"UWPriority"),accounts:_.sortBy(_.pluck(_.filter(this.model.models,function(n){return n&&!u(n)}),"attributes"),"UWPriority"),hideAccounts:!1,hideMarketplaces:!1,summary:{monthSales:0,anualSales:0,inventory:0,positive:0,negative:0,neutral:0,monthAnnualizedSales:0}},e=n.marketplaces,i=0,o=e.length;i<o;i++)t=e[i],t.Disabled===!1&&(n.summary.monthSales+=t.monthSales),t.Disabled===!1&&(n.summary.anualSales+=t.anualSales),t.Disabled===!1&&(n.summary.monthAnnualizedSales+=t.monthAnnualizedSales),t.Disabled===!1&&(n.summary.inventory+=t.inventory),n.summary.positive+=t.PositiveFeedbacks,n.summary.negative+=t.NegativeFeedbacks,n.summary.neutral+=t.NeutralFeedbacks;return f=n.summary.positive+n.summary.negative+n.summary.neutral,n.summary.rating=f>0?n.summary.positive/f:0,n},i.prototype.disableShop=function(n){var t,i,r=this;return t=$(n.currentTarget),i=t.attr("umi"),EzBob.ShowMessage("Disable shop","Are you sure?",function(){return r.doEnableShop(i,!1)},"Yes",null,"No"),!1},i.prototype.doEnableShop=function(n,t){var i,r,u=this;return i=t?""+window.gRootPath+"Underwriter/MarketPlaces/Enable":""+window.gRootPath+"Underwriter/MarketPlaces/Disable",r=$.post(i,{umi:n}),r.done(function(){return u.model.fetch()})},i.prototype.enableShop=function(n){var t,i,r=this;return t=$(n.currentTarget),i=t.attr("umi"),EzBob.ShowMessage("Enable shop","Are you sure?",function(){return r.doEnableShop(i,!0)},"Yes",null,"No"),!1},i.prototype.tryRecheckYodlee=function(){},i.prototype.reCheckmarketplaces=function(n){var t,r,u,f,i,e=this;return t=$(n.currentTarget),i=t.attr("umi"),u=t.attr("marketplaceType"),r=this.model.customerId,f=function(){var n;return n=$.post(""+window.gRootPath+"Underwriter/MarketPlaces/ReCheckMarketplaces",{customerId:r,umi:i,marketplaceType:u}),n.done(function(n){return n&&n.error!==void 0?EzBob.ShowMessage(n.error,"Error occured"):EzBob.ShowMessage("Wait a few minutes","The marketplace recheck is running. ",null,"OK"),e.trigger("rechecked",{umi:i,el:t})}),n.fail(function(n){return console.error(n.responseText)})},EzBob.ShowMessage("","Are you sure?",f,"Yes",null,"No"),!1},i.prototype.renewTokenClicked=function(n){var t;return t=$(n.currentTarget).data("umi"),this.renewToken(t),!1},i.prototype.renewToken=function(n){var t;return t=$.post(""+window.gRootPath+"Underwriter/MarketPlaces/RenewEbayToken",{umi:n}),t.done(function(){return EzBob.ShowMessage("Renew started successfully","Successfully")})},i}(Backbone.Marionette.ItemView)}).call(this)