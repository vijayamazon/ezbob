(function(){var t,i={}.hasOwnProperty,n=function(n,t){function u(){this.constructor=n}for(var r in t)i.call(t,r)&&(n[r]=t[r]);return u.prototype=t.prototype,n.prototype=new u,n.__super__=t.prototype,n},r=[].slice;t=typeof exports!="undefined"&&exports!==null?exports:this;t.EzBob=t.EzBob||{};EzBob.Installment=function(t){function i(){return i.__super__.constructor.apply(this,arguments)}return n(i,t),i.prototype.defaults={IsAdding:!1,skipRecalculations:!1},i.prototype.initialize=function(){this.on("change:Balance",this.balanceChanged,this);this.on("change:Principal",this.principalChanged,this);this.on("change:Total",this.totalChanged,this);return this.on("change:Date",this.dateChanged,this)},i.prototype.balanceChanged=function(){return this.safeRecalculate(function(){var n;if(this.get("Balance")!==this.previous("Balance"))return n=this.round(this.get("BalanceBeforeRepayment")-this.get("Balance")),this.set("Principal",n),this.recalculate()})},i.prototype.totalChanged=function(){return this.safeRecalculate(function(){var n;if(n=this.get("Total")-this.previous("Total"),n!==0)return this.set("Balance",this.get("Balance")-n),this.set("Principal",this.get("Principal")+n)})},i.prototype.principalChanged=function(){return this.safeRecalculate(function(){var n;if(n=this.get("Principal")-this.previous("Principal"),n!==0)return this.set("Balance",this.get("Balance")-n),this.recalculate()})},i.prototype.safeRecalculate=function(){var n,t;if(n=arguments[0],t=2<=arguments.length?r.call(arguments,1):[],!this.skipRecalculations)return this.skipRecalculations=!0,n.call(this,t),this.skipRecalculations=!1},i.prototype.recalculate=function(){return this.set({Total:this.get("Principal")+this.get("Interest")+this.get("Fees")})},i.prototype.dateChanged=function(){return this.set("Date",new Date(moment.utc(this.get("Date"))))},i.prototype.round=function(n){return n=Math.round(n*100),n/100},i}(Backbone.Model);EzBob.Installments=function(t){function i(){return i.__super__.constructor.apply(this,arguments)}return n(i,t),i.prototype.model=EzBob.Installment,i.prototype.comparator=function(n,t){var r,u,f,i;return u=moment.utc(n.get("Date")).startOf("day"),f=moment.utc(t.get("Date")).startOf("day"),r=u.diff(f,"days"),i=r<0?-1:r===0?0:1,i===0&&n.get("Type")!==t.get("Type")&&(i=n.get("Type")==="Installment"?1:-1),i},i}(Backbone.Collection);EzBob.LoanModel=function(t){function i(){return i.__super__.constructor.apply(this,arguments)}return n(i,t),i.prototype.url=function(){return""+window.gRootPath+"Underwriter/LoanEditor/Loan/"+this.get("Id")},i.prototype.initialize=function(){var n=new EzBob.Installments;n.on("change",this.itemsChanged,this);return this.set("Items",n)},i.prototype.itemsChanged=function(){return this.trigger("change")},i.prototype.shiftDate=function(n,t,i){var c,l,f,u,s,r,e,h,o;for(t=moment.utc(t),i=moment.utc(i),f=t-i,s=this.get("Items").indexOf(n),o=this.get("Items").models,u=e=0,h=o.length;e<h;u=++e)(r=o[u],u>s)&&(c=moment.utc(r.get("Date")),l=moment.utc(r.get("Date")).add(f),r.set("Date",moment.utc(r.get("Date")).add(f).toDate()));return!1},i.prototype.shiftInterestRate=function(n,t){var i,f,e,r,o,u;for(f=this.get("Items").indexOf(n),u=this.get("Items").models,i=r=0,o=u.length;r<o;i=++r)e=u[i],i>f&&e.set("InterestRate",t);return!1},i.prototype.parse=function(n){return _.each(n.Items,function(n){return n.Date=new Date(moment.utc(n.Date))}),this.get("Items").reset(n.Items),delete n.Items,n.Date=new Date(moment.utc(n.Date)),n},i.prototype.toJSON=function(){var n;return n=i.__super__.toJSON.call(this),n.Items=n.Items.toJSON(),n},i.prototype.removeItem=function(n){var t;return t=this.get("Items"),t.remove(t.at(n)),this.recalculate()},i.prototype.addInstallment=function(n){return this.get("Items").add(n),this.recalculate()},i.prototype.addFee=function(n){this.get("Items").add(n);this.recalculate()},i.prototype.recalculate=function(){return this.save({},{url:""+window.gRootPath+"Underwriter/LoanEditor/Recalculate/"+this.get("Id")})},i.prototype.addFreezeInterval=function(n,t,i){return this.save({},{url:""+window.gRootPath+"Underwriter/LoanEditor/AddFreezeInterval/"+this.get("Id")+"?startdate="+n+"&enddate="+t+"&rate="+i})},i.prototype.removeFreezeInterval=function(n){return this.save({},{url:""+window.gRootPath+"Underwriter/LoanEditor/RemoveFreezeInterval/"+this.get("Id")+"?intervalid="+n})},i.prototype.getInstallmentBefore=function(n){var r,t,i,f,u;for(n=moment.utc(n).toDate(),r=null,u=this.get("Items").models,i=0,f=u.length;i<f;i++)t=u[i],t.get("Type")==="Installment"&&moment.utc(t.get("Date")).toDate()<n&&(r=t);return r},i.prototype.getInstallmentAfter=function(n){var t,i,u,r;for(n=moment.utc(n).toDate(),r=this.get("Items").models,i=0,u=r.length;i<u;i++)if(t=r[i],t.get("Type")==="Installment"&&moment.utc(t.get("Date")).toDate()>n)return t;return null},i}(Backbone.Model);EzBob.LoanModelTemplate=function(t){function i(){return i.__super__.constructor.apply(this,arguments)}return n(i,t),i.prototype.url=function(){return""+window.gRootPath+"Underwriter/LoanEditor/LoanCR/"+this.get("CashRequestId")},i.prototype.recalculate=function(){return this.save({},{url:""+window.gRootPath+"Underwriter/LoanEditor/RecalculateCR"})},i}(EzBob.LoanModel)}).call(this)