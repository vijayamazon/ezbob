(function(){var n,t={}.hasOwnProperty,i=function(n,i){function u(){this.constructor=n}for(var r in i)t.call(i,r)&&(n[r]=i[r]);return u.prototype=i.prototype,n.prototype=new u,n.__super__=i.prototype,n};n=typeof exports!="undefined"&&exports!==null?exports:this,n.EzBob=n.EzBob||{},EzBob.EditLoanView=function(n){function t(){return t.__super__.constructor.apply(this,arguments)}return i(t,n),t.prototype.template="#loan_editor_template",t.prototype.scheduleTemplate=_.template($("#loan_editor_schedule_template").html()),t.prototype.initialize=function(){return this.bindTo(this.model,"change sync",this.renderRegions,this),this.editItemIndex=-1},t.prototype.serializeData=function(){var n;return n=this.model.toJSON(),n.editItemIndex=this.editItemIndex,n},t.prototype.ui={scheduleEl:".editloan-schedule-region",freezeEl:".editloan-freeze-intervals-region",ok:".save",buttons:".buttons"},t.prototype.editors={Installment:EzBob.InstallmentEditor,Fee:EzBob.FeeEditor},t.prototype.events={"click .edit-schedule-item":"editScheduleItem","click .remove-schedule-item":"removeScheduleItem","click .add-installment":"addInstallment","click .add-fee":"addFee","click .save":"onOk","click .cancel":"onCancel","click .add-freeze-interval":"onAddFreezeInterval","click .remove-freeze-interval":"onRemoveFreezeInterval"},t.prototype.addInstallment=function(){var r,n,u,t,i;n=new Date(this.model.get("Items").last().get("Date")),n.setMonth(n.getMonth()+1),t=new EzBob.Installment({Editable:!0,Deletable:!0,Editor:"Installment",Principal:0,Balance:0,BalanceBeforeRepayment:0,Interest:0,InterestRate:this.model.get("InterestRate"),Fees:0,Total:0,Status:"StillToPay",Type:"Installment",IsAdding:!0,Date:n}),u=this.editors.Installment,i=new u({model:t,loan:this.model}),r=function(){return this.model.addInstallment(t)};i.on("apply",r,this);return this.showEditView(i)},t.prototype.addFee=function(){var i,r,n,t;n=new EzBob.Installment({Editable:!0,Deletable:!0,Editor:"Fee",Principal:0,Balance:0,BalanceBeforeRepayment:0,Interest:0,InterestRate:this.model.get("InterestRate"),Fees:0,Total:0,Type:"Fee",IsAdding:!0,Date:this.model.get("Items").last().get("Date")}),r=this.editors.Fee,t=new r({model:n,loan:this.model}),i=function(){return this.model.addFee(n)};t.on("apply",i,this);return this.showEditView(t)},t.prototype.showEditView=function(n){var t=this;n.on("close",function(){return t.ui.buttons.show()});return this.editRegion.show(n),this.ui.buttons.hide()},t.prototype.removeScheduleItem=function(n){var t,i,r=this;return t=n.currentTarget.getAttribute("data-id"),i=function(){return r.model.removeItem(t)},EzBob.ShowMessage("Confirm deleting installment","Delete installment",i,"Ok",null,"Cancel")},t.prototype.editScheduleItem=function(n){var f,e,i,r,u,t;i=n.currentTarget.getAttribute("data-id"),u=$(n.currentTarget).parents("tr"),u.addClass("editing"),r=this.model.get("Items").at(i),this.editItemIndex=i,e=this.editors[r.get("Editor")],t=new e({model:r,loan:this.model});t.on("apply",this.recalculate,this);f=function(){return u.removeClass("editing"),this.editItemIndex=-1,this.renderSchedule()};t.on("close",f,this);return this.showEditView(t)},t.prototype.recalculate=function(){return this.model.recalculate()},t.prototype.onOk=function(){var n,t=this;if(!this.ui.ok.hasClass("disabled"))return n=this.model.save(),n.done(function(){return t.trigger("item:saved"),t.close()})},t.prototype.onCancel=function(){return this.close()},t.prototype.onRender=function(){return this.editRegion=new Backbone.Marionette.Region({el:this.$(".editloan-item-editor-region")}),this.renderRegions()},t.prototype.renderRegions=function(){return this.renderSchedule(),this.renderFreeze()},t.prototype.renderSchedule=function(){return this.ui.scheduleEl.html(this.scheduleTemplate(this.serializeData())),this.ui.ok.toggleClass("disabled",this.model.get("HasErrors"))},t.prototype.renderFreeze=function(){return this.ui.freezeEl.html(_.template($("#loan_editor_freeze_intervals_template").html())(this.serializeData()))},t.prototype.onAddFreezeInterval=function(){var i,n,t;return t=this.$el.find(".new-freeze-interval-start").val(),n=this.$el.find(".new-freeze-interval-end").val(),i=this.$el.find(".new-freeze-interval-rate").val()/100,this.$el.find(".new-freeze-interval-error").empty(),this.validateFreezeIntervals(t,n)?this.model.addFreezeInterval(t,n,i):this.$el.find(".new-freeze-interval-error").text("New interval conflicts with one of existing intervals")},t.prototype.onRemoveFreezeInterval=function(n){return this.model.removeFreezeInterval(n.currentTarget.getAttribute("data-id"))},t.prototype.validateFreezeIntervals=function(n,t){var u,i,r,f,e=this;return r=moment.utc(n),i=moment.utc(t),r!==null&&i!==null&&r>i&&(this.$el.find(".new-freeze-interval-start").val(t),this.$el.find(".new-freeze-interval-end").val(n),f=i,i=r,r=f),u=!1,_.each(this.model.get("InterestFreeze"),function(n){var t,f,o,s,h;if(!u)return(t=n.split("|"),t[4]!=="")?void 0:(s=moment.utc(t[0]),h=moment.utc(t[1]),f=e.cmpDates(r,h),o=e.cmpDates(s,i),u=f&&o)}),!u},t.prototype.cmpDates=function(n,t){return n===null||t===null?!0:n<=t},t.prototype.onClose=function(){return this.editRegion.close()},t.prototype.jqoptions=function(){return{width:1e3,modal:!0,title:"Edit Loan Details",resizable:!0}},t}(Backbone.Marionette.ItemView)}).call(this)