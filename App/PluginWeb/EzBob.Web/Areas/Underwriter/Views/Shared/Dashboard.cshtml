@model dynamic
<script id="dashboard-template" type="text/template">
    <div class="row">
        <div class="col-md-3">
            <div class="row">
                <div class="box">
                    <div class="box-title">
                        <h3><i class="fa fa-bar-chart-o"></i>Customer Input</h3>
                        <div class="box-tool">
                            <a data-action="collapse" href="#"><i class="fa fa-chevron-up"></i></a>
                            <a data-action="close" href="#"><i class="fa fa-times"></i></a>
                        </div>
                    </div>
                    <div class="box-content">
                        <%
                            var rl = m.RequestedLoan || {},
                            cec = m.CompanyEmployeeCountInfo || {};
                        %>
                        <div>Requested loan: <%-rl!=null ? EzBob.formatPoundsNoDecimals(rl.Amount, true) : "-"%></div>
                        <div>Annual turnover: <%- EzBob.formatPoundsNoDecimals(m.OverallTurnOver) %></div>
                        <div># of employees: <%- cec.EmployeeCount %> employees</div>
                        <div>Total Monthly salary cost: <%- EzBob.formatPoundsAsInt(cec.TotalMonthlySalary) %></div>
                    </div>
                </div>
            </div>
            <div class="row">
                <%if(properties){%>
            <div class="box">
                <div class="box-title">
                    <h3><i class="fa fa-bar-chart-o"></i>Assets & Worth</h3>
                    <div class="box-tool">
                        <a data-action="collapse" href="#"><i class="fa fa-chevron-up"></i></a>
                        <a data-action="close" href="#"><i class="fa fa-times"></i></a>
                    </div>
                </div>
                <div class="box-content">
                    <div class="row">
                        <div class="col-md-6 col-sm-6">
                            <div class="tile tile-grey">
                                <div class="caption text-center">
                                    Properties
                                </div>
                                <p class="title text-center"><strong><%- properties.NumberOfProperties %></strong></p>
                            </div>
                        </div>
                        <div class="col-md-6 col-sm-6">
                            <div class="tile tile-grey">
                                <div class="caption text-center">
                                    Market value
                                </div>
                                <p class="title text-center"><%- EzBob.formatPoundsAsThousandsNoDecimals(properties.MarketValue) %></p>
                            </div>
                        </div>
                        <div class="col-md-6 col-sm-6">
                            <div class="tile tile-lightgrey tile-high">
                                <div class="caption text-center">
                                    Net Worth
                                </div>
                                <p class="title text-center blue-special"><strong><%- EzBob.formatPoundsAsThousandsNoDecimals(properties.NetWorth) %></strong></p>
                                <p class="title-small text-center">(<%- properties.NetWorthPercentages %>%)</p>
                            </div>
                        </div>
                        <div class="col-md-6 col-sm-6">
                            <div class="tile tile-lightgrey tile-high">
                                <div class="caption text-center">
                                    Mortgages (<%- properties.NumberOfMortgages %>)
                                </div>
                                <p class="title text-center"><%- EzBob.formatPoundsAsThousandsNoDecimals(properties.SumOfMortgages) %></p>
                                <p class="title-small text-center">(LTV: <%- properties.Ltv %>%)</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <%}%>
            </div>
        </div>

        <%
            var aff = {};
            var dates = {};
            if(affordability && affordability.length == 1 && affordability[0].CGData){
			
			if (affordability[0].CGData.VatReturnSummary && affordability[0].CGData.VatReturnSummary[0])
				aff = affordability[0].CGData.VatReturnSummary[0];

			var dates = {};
			if (affordability[0].CGData.VatReturnSummaryDates && affordability[0].CGData.VatReturnSummaryDates[0])
				dates = affordability[0].CGData.VatReturnSummaryDates[0];
        }%>
        <div class="col-md-9">
            <div class="box">
                <div class="box-title">
                    <h3><i class="fa fa-bar-chart-o"></i>Affordability</h3>
                    <div class="box-tool">
                        <a data-action="collapse" href="#"><i class="fa fa-chevron-up"></i></a>
                        <a data-action="close" href="#"><i class="fa fa-times"></i></a>
                    </div>
                </div>
                <div class="box-content">
                    <table class="table table-striped">
                        <tbody>
                            <tr>
                                <td><i>annual</i></td>
                                <td><span class="<%-dates.TotalSummaryDays < 350 ? 'label label-large label-important' : ''%>"><%-moment(dates.DateFrom).format("MMM YY")%> - <%-moment(dates.DateTo).format("MMM YY")%></span></td>
                            </tr>
                            <tr>
                                <td>revenues</td>
                                <td class="<%-NegativeNum(aff.Revenues)%>"><%-EzBob.formatPoundsNoDecimals(aff.Revenues)%></td>
                            </tr>
                            <tr>
                                <td>opex</td>
                                <td class="<%-NegativeNum(aff.Opex)%>"><%-EzBob.formatPoundsNoDecimals(aff.Opex)%></td>
                            </tr>
                            <tr class="chkpt">
                                <td>value added</td>
                                <td class="<%-NegativeNum(aff.TotalValueAdded)%>"><%-EzBob.formatPoundsNoDecimals(aff.TotalValueAdded)%></td>
                            </tr>
                            <tr>
                                <td>salaries</td>
                                <td class="<%-NegativeNum(aff.Salaries)%>"><%-EzBob.formatPoundsNoDecimals(aff.Salaries)%></td>
                            </tr>
                            <tr>
                                <td>tax</td>
                                <td class="<%-NegativeNum(aff.Tax)%>"><%-EzBob.formatPoundsNoDecimals(aff.Tax)%></td>
                            </tr>
                            <tr class="chkpt">
                                <td>EBITDA</td>
                                <td class="<%-NegativeNum(aff.Ebida)%>"><%-EzBob.formatPoundsNoDecimals(aff.Ebida)%></td>
                            </tr>
                            <tr>
                                <td>loan repayment</td>
                                <td class="<%-NegativeNum(aff.ActualLoanRepayment)%>"><%-EzBob.formatPoundsNoDecimals(aff.ActualLoanRepayment)%></td>
                            </tr>
                            <tr class="chkpt">
                                <td>FCF</td>
                                <td><span class="label label-large <%- aff.FreeCashFlow < 0 ? 'label-important' : 'label-success' %>"><%-EzBob.formatPoundsNoDecimals(aff.FreeCashFlow)%></span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <%if(experian) {
            experian.Summary = experian.Summary || {};
            experian.Summary.ConsumerAccountsOverview = experian.Summary.ConsumerAccountsOverview || {};
            experian.ConsumerSummaryCharacteristics = experian.ConsumerSummaryCharacteristics || {};
            experian.ConsumerAccountsOverview = experian.ConsumerAccountsOverview || {};
            var experianCompany = experian.LimitedInfo || experian.NonLimitedInfo || {};
            var tileColor='';
            if(!EzBob.isDarkColor(experian.ScoreColor)){
            tileColor = 'tile-light';
            }
        %>
        <div class="col-md-6 col-sm-12">
            <div class="box">
                <div class="box-title">
                    <h3><i class="fa fa-bar-chart-o"></i>Customer & Directors</h3>
                    <div class="box-tool">
                        <a data-action="collapse" href="#"><i class="fa fa-chevron-up"></i></a>
                        <a data-action="close" href="#"><i class="fa fa-times"></i></a>
                    </div>
                </div>
                <div class="box-content">
                    <div class="tabbable tabs-left">
                        <ul class="nav nav-tabs active active-blue">
                            <li class="active"><a href="#customerExperian" data-toggle="tab"><span class="<%-tileColor%>" style="background-color: <%-experian.ScoreColor%>;"><%-experian.Score%></span>&nbsp;Applicant</a></li>
                            <%if(experian.directorsModels && experian.directorsModels.length > 0){
                                _.each(experian.directorsModels, function(item, i){
                                    var directorTileColor='';
                                    if(!EzBob.isDarkColor(item.ScoreColor)){
                                        directorTileColor = 'tile-light';
                                    }
                            %>
                            <li><a href="#director<%-i%>" data-toggle="tab"><span class="<%-directorTileColor%>" style="background-color: <%-item.ScoreColor%>;"><%-item.Score%></span> Director <%-(i+1)%></a></li>
                            <%});}%>
                        </ul>
                        <div class="tab-content no-border">
                            <div class="tab-pane fade active in" id="customerExperian">
                                <div class="">
                                    <div class="col-md-3 col-sm-4">
                                        <div class="tile <%-tileColor%>" style="background-color: <%-experian.ScoreColor%>">
                                            <div class="caption text-center">
                                                Score
                                            </div>
                                            <p class="title text-center"><%-experian.Score%></p>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-sm-4">
                                        <div class="tile tile-lightgrey">
                                            <div class="caption text-center">
                                                Indebtedness index
                                            </div>
                                            <p class="title text-center"><%-experian.CII%></p>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-sm-4">
                                        <div class="tile tile-transparant">
                                            <div class="caption text-center">
                                                Total CAIS balance
                                            </div>
                                            <% var balance = EzBob.formatPoundsAsThousandsNoDecimals(experian.ConsumerAccountsOverview.Balance_Total);
                                   var textSize = '';
                                if(balance.length > 5){ textSize = 'text-small';} %>
                                <p class="title text-center <%- textSize%>"><%-EzBob.formatPoundsAsThousandsNoDecimals(experian.ConsumerAccountsOverview.Balance_Total)%></p>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-sm-4">
                                        <div class="tile <%- experian.ConsumerSummaryCharacteristics.NumberOfDefaults == 0 ? 'tile-lightgreen' : 'tile-red' %>">
                                            <div class="caption text-center">
                                                Defaults
                                            </div>
                                            <p class="title text-center"><%-experian.ConsumerSummaryCharacteristics.NumberOfDefaults%></p>
                                        </div>
                                    </div>
                                </div>
                                <div class="">
                                    <div class="col-md-3 col-sm-4">
                                        <div class="tile tile-transparant">
                                            <span class="inline-sparkline consumerScoreGraph"></span>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-sm-4">
                                        <div class="tile tile-transparant">
                                            <span class="inline-sparkline consumerCIIGraph"></span>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-sm-4">
                                        <div class="tile <%- experian.ConsumerAccountsOverview.OpenAccounts_Total==0 ? 'tile-red' : 'tile-lightgreen' %>">
                                            <div class="caption text-center">
                                                CAIS Accounts
                                            </div>
                                            <p class="title text-center"><%-experian.ConsumerAccountsOverview.OpenAccounts_Total%></p>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-sm-4">
                                        <div class="tile <%- experian.Summary.CCJs == 0 ? 'tile-lightgreen' : 'tile-red' %>">
                                            <div class="caption text-center">
                                                CCJ/Recent CCJ(m)
                                            </div>
                                            <p class="title text-center"><%-experian.Summary.CCJs%> / <%-experian.Summary.MostrecentCCJ%>m</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <%if(experian.directorsModels && experian.directorsModels.length > 0){
                    _.each(experian.directorsModels, function(item, i){
                            item.Summary = item.Summary || {};
                            item.Summary.ConsumerAccountsOverview = item.Summary.ConsumerAccountsOverview || {};
                            item.ConsumerSummaryCharacteristics = item.ConsumerSummaryCharacteristics || {};
                            item.ConsumerAccountsOverview = item.ConsumerAccountsOverview || {};%>
                        <div class="tab-pane fade in" id="director<%-i%>">
                            <div class="">
                                <div class="col-md-3 col-sm-4">
                                    <%var tileColor='';
                                    if(!EzBob.isDarkColor(item.ScoreColor)){
                                        tileColor = 'tile-light';
                                    }%>
                                    <div class="tile <%-tileColor%>" style="background-color: <%-item.ScoreColor%>">
                                        <div class="caption text-center">
                                            Director <%-(i+1)%>
                                        </div>
                                        <p class="title text-center"><%-item.Score%></p>
                                    </div>
                                </div>
                                <div class="col-md-3 col-sm-4">
                                    <div class="tile tile-lightgrey">
                                        <div class="caption text-center">
                                            Indebtedness index
                                        </div>
                                        <p class="title text-center"><%-item.CII%></p>
                                    </div>
                                </div>
                                <div class="col-md-3 col-sm-4">
                                    <div class="tile tile-transparant">
                                        <div class="caption text-center">
                                            Total CAIS balance:
                                        </div>
                                        <% var balance = EzBob.formatPoundsAsThousandsNoDecimals(item.ConsumerAccountsOverview.Balance_Total);
                                            var textSize = '';
                                        if(balance.length > 5){ textSize = 'text-small';} %>
                                        <p class="title text-center <%- textSize%>"><%-EzBob.formatPoundsAsThousandsNoDecimals(item.ConsumerAccountsOverview.Balance_Total)%></p>
                                    </div>
                                </div>
                                <div class="col-md-3 col-sm-4">
                                    <div class="tile <%- item.ConsumerSummaryCharacteristics.NumberOfDefaults == 0 ? 'tile-lightgreen' : 'tile-red' %>">
                                        <div class="caption text-center">
                                            Defaults
                                        </div>
                                        <p class="title text-center"><%-item.ConsumerSummaryCharacteristics.NumberOfDefaults%></p>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <div class="col-md-3 col-sm-4">
                                    <div class="tile tile-transparant">
                                        score trend N/A
                                    </div>
                                </div>
                                <div class="col-md-3 col-sm-4">
                                    <div class="tile tile-transparant">
                                        CII trend N/A
                                    </div>
                                </div>
                                <div class="col-md-3 col-sm-4">
                                    <div class="tile <%- item.ConsumerAccountsOverview.OpenAccounts_Total==0 ? 'tile-red' : 'tile-lightgreen' %>">
                                        <div class="caption text-center">
                                            CAIS Accounts:
                                        </div>
                                        <p class="title text-center"><%-item.ConsumerAccountsOverview.OpenAccounts_Total%></p>
                                    </div>
                                </div>
                                <div class="col-md-3 col-sm-4">
                                    <div class="tile <%- item.Summary.CCJs == 0 ? 'tile-lightgreen' : 'tile-red' %>">
                                        <div class="caption text-center">
                                            CCJ/Recent CCJ(m)
                                        </div>
                                        <p class="title text-center"><%-item.Summary.CCJs%> / <%-item.Summary.MostrecentCCJ%>m</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                            <%});}%>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <%}%>
        
        <%if(experianCompany){
            var tileColor='';
            if(!EzBob.isDarkColor(experianCompany.ScoreColor)){
                tileColor = 'tile-light';
            }%>
        <div class="col-md-6 col-sm-12">
            <div class="box">
                <div class="box-title">
                    <h3><i class="fa fa-bar-chart-o"></i>Company Credit Profile</h3>
                    <div class="box-tool">
                        <a data-action="collapse" href="#"><i class="fa fa-chevron-up"></i></a>
                        <a data-action="close" href="#"><i class="fa fa-times"></i></a>
                    </div>
                </div>
                <div class="box-content">
                    <div class="row">
                        <div class="col-md-2 col-sm-4">
                            <div class="tile <%-tileColor%>" style="background-color: <%-experianCompany.ScoreColor%>">
                                <div class="caption text-center">
                                    Score
                                </div>
                                <p class="title text-center"><%-experianCompany.BureauScore%></p>
                            </div>
                        </div>
                        <div class="col-md-2 col-sm-4">
                            <div class="tile tile-lightgrey">
                                <div class="caption text-center">
                                    CCJ
                                </div>
                                <p class="title text-center">N/A</p>
                            </div>
                        </div>
                        <div class="col-md-2 col-sm-4">
                            <div class="tile tile-lightgrey">
                                <div class="caption text-center">
                                    Tangible equity
                                </div>
                                <p class="title text-center">N/A</p>
                            </div>
                        </div>
                        <div class="col-md-2 col-sm-4">
                            <div class="tile tile-lightgrey">
                                <div class="caption text-center">
                                    Adjusted profit
                                </div>
                                <p class="title text-center">N/A</p>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-2 col-sm-4">
                            <div class="tile tile-transparant">
                                <span class="inline-sparkline companyScoreGraph"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <%}%>
    </div>
    <div class="row">
        <%if(m.LoanActivity && m.Decisions && m.Decisions.TotalDecisionsCount > 0){
            var activeLoans = m.LoanActivity.TotalIssuesCount > 0 ? "active" : "";
            var activeDecisions = activeLoans == "" ? "active" : "";
        %>
        <div class="col-md-12">
            <div class="box">
                <div class="box-title">
                    <h3><i class="fa fa-bar-chart-o"></i>Customer History</h3>
                    <div class="box-tool">
                        <a data-action="collapse" href="#"><i class="fa fa-chevron-up"></i></a>
                        <a data-action="close" href="#"><i class="fa fa-times"></i></a>
                    </div>
                </div>
                <div class="box-content">
                    <div class="tabbable tabs-left">
                        <ul class="nav nav-tabs active-blue">
                            <li class="<%-activeLoans%>"><a href="#loans" data-toggle="tab"><span class="label label-large label-warning"><%-m.LoanActivity.TotalIssuesCount%></span>&nbsp;Loans</a></li>
                            <li class="<%-activeDecisions%>"><a href="#decisions" data-toggle="tab"><span class="label label-large label-success"><%-m.Decisions.TotalDecisionsCount%></span>&nbsp;Decisions</a></li>
                        </ul>
                        <div class="tab-content">
                            <div class="tab-pane fade <%-activeLoans%> in" id="loans">
                                <ul class="summary-offer">
                                    <li>
                                        <p>
                                            <span>Total issues</span>
                                            <span><%-EzBob.formatPoundsNoDecimals(m.LoanActivity.TotalIssuesSum)%></span>
                                            <span><%-m.LoanActivity.TotalIssuesCount%></span>
                                        </p>
                                    </li>
                                    <li>
                                        <p>
                                            <span>Repaid</span>
                                            <span><%-EzBob.formatPoundsNoDecimals(m.LoanActivity.RepaidSum)%></span>
                                            <span><%-m.LoanActivity.RepaidCount%></span>
                                        </p>
                                    </li>
                                    <li>
                                        <p>
                                            <span>Active</span>
                                            <span><%-EzBob.formatPoundsNoDecimals(m.LoanActivity.ActiveSum)%></span>
                                            <span><%-m.LoanActivity.ActiveCount%></span>
                                        </p>
                                    </li>
                                    <li>
                                        <p>
                                            <span>Earned interest</span>
                                            <span><%-EzBob.formatPoundsNoDecimals(m.LoanActivity.EarnedInterest)%></span>
                                        </p>
                                    </li>
                                </ul>
                            </div>
                            <div class="tab-pane fade <%-activeDecisions%> in" id="decisions">
                                <ul class="summary-offer">
                                    <li>
                                        <p>
                                            <span># Decisions</span>
                                            <span><%-m.Decisions.TotalDecisionsCount%></span>
                                        </p>
                                    </li>
                                    <li>
                                        <p>
                                            <span>Total approved</span>
                                            <span><%-EzBob.formatPoundsNoDecimals(m.Decisions.TotalApprovedAmount)%></span>
                                        </p>
                                    </li>
                                    <li>
                                        <p>
                                            <span># Rejects</span>
                                            <span><%-m.Decisions.RejectsCount%></span>
                                        </p>
                                    </li>
                                    <%if(m.Decisions.LastInterestRate > 0){%>
                                    <li>
                                        <p>
                                            <span>Last interest rate</span>
                                            <span><%-EzBob.formatPercents(m.Decisions.LastInterestRate)%></span>
                                        </p>
                                    </li>
                                    <li>
                                        <p>
                                            <span>Last approval date</span>
                                            <span><%-EzBob.formatDate(new Date(moment(m.Decisions.LastDecisionDate)))%></span>
                                        </p>
                                    </li>
                                    <li>
                                        <p>
                                            <span>Time past from last approval</span>
                                            <span><%-moment(m.Decisions.LastDecisionDate).fromNow()%></span>
                                        </p>
                                    </li>
                                    <%}%>
                                </ul>
                            </div>
                            <div class="tab-pane fade" id="rejects">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Comment</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Oct 1 2013</td>
                                            <td>low sales</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <%}%>
    </div>
    <%m.DecisionHistory = m.DecisionHistory || {};%>
    <%if(m.DecisionHistory.length > 0){%>
    <div class="row">
        <div class="col-md-12">
            <div class="box">
                <div class="box-title">
                    <h3><i class="fa fa-bar-chart-o"></i>Journal</h3>
                    <div class="box-tool">
                        <a data-action="collapse" href="#"><i class="fa fa-chevron-up"></i></a>
                        <a data-action="close" href="#"><i class="fa fa-times"></i></a>
                    </div>
                </div>
                <div class="box-content">

                    <table class="table centered">
                        <thead class="box">
                            <tr class="box-title">
                                <th>Action </th>
                                <th style="width: 100px;">Date </th>
                                <th>Approved Sum </th>
                                <th>Interest </th>
                                <th>Repayment Period </th>
                                <th>Loan Type </th>
                                <th>Use Setup Fee </th>
                                <th>Discount Plan </th>
                                <th>Customer Selection </th>
                                <th>Loan Source </th>
                                <th>Originator </th>
                                <th>Underwriter </th>
                                <th>Comment </th>
                                <th>ID </th>
                            </tr>
                        </thead>
                        <tbody>
                            <%_.each(m.DecisionHistory, function(d){%>
                            <tr>
                                <td><%- d.Action %></td>
                                <td><%- EzBob.formatDate(d.Date) %></td>
                                <% if (d.Action == "Reject") {%>
                                    <td colspan="8"></td>
                                <%} else {%>
                                    <td><%- EzBob.formatPounds(d.ApprovedSum) %></td>
                                <td><%- EzBob.formatPercents(d.InterestRate) %></td>
                                <td><%- d.RepaymentPeriod %></td>
                                <td><%- EzBob.formatLoanType(d.IsLoanTypeSelectionAllowed, d.LoanType) %></td>
                                <td><%- (d.ManualSetupFeeAmount || d.ManualSetupFeePercent) ? 'Manual' : (d.UseBrokerSetupFee ? 'Broker' : (d.UseSetupFee ? 'Setup Fee' : 'No')) %></td>
                                <td><%- d.DiscountPlan %></td>
                                <td><%- EzBob.formatLoanTypeSelection(d.IsLoanTypeSelectionAllowed) %></td>
                                <td><%- d.LoanSourceName %></td>
                                <%}%>
                                <td><%- d.Originator %></td>
                                <td><%- d.UnderwriterName %></td>
                                <td><%- d.Comment %></td>
                                <td><%- d.Id %></td>
                            </tr>
                            <%});%>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <%}%>

</script>

